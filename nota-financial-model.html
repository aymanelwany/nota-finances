<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nota Financial Model Calculator - 3 Year Projection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: #111;
        }
        
        .header p {
            color: #666;
        }
        
        .cost-per-user-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .metric-sub {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .config-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .subsection-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .scenario-btn {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scenario-btn:hover {
            border-color: #3b82f6;
        }
        
        .scenario-btn.active {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #1d4ed8;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            color: #555;
        }
        
        .input-group input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .revenue-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .revenue-card h4 {
            margin-bottom: 12px;
        }
        
        .revenue-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .loan-model-card {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .loan-model-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }
        
        td {
            padding: 8px 12px;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:nth-child(even) {
            background: #f9fafb;
        }
        
        .summary-section {
            background: linear-gradient(to right, #2563eb, #9333ea);
            padding: 24px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Step-based styling */
        .step-container {
            background: white;
            border-radius: 12px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
        }

        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .step-intro {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .step-content {
            padding: 24px;
        }

        .progress-bar {
            background: #f3f4f6;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(to right, #10b981, #059669);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            margin-right: 16px;
        }

        .next-button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }

        .next-button:hover {
            transform: translateY(-2px);
        }

        .simplified-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .simple-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .simple-card.active {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .conclusion-box {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 30px 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .summary-item p:first-child {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .summary-item p:last-child {
            font-size: 24px;
            font-weight: bold;
        }
        
        .text-green { color: #16a34a; }
        .text-red { color: #dc2626; }
        .text-blue { color: #2563eb; }
        .text-purple { color: #9333ea; }
        
        /* Info Modal Styles */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 6px;
            user-select: none;
        }
        
        .info-icon:hover {
            background: #2563eb;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .formula-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            text-align: center;
        }
        
        .example-box {
            background: #ecfdf5;
            border: 1px solid #d1fae5;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .header {
                padding: 16px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 20px;
                margin-bottom: 6px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            /* Header currency selector responsive */
            .header > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px !important;
            }
            
            .cost-per-user-card {
                padding: 16px;
                margin-bottom: 15px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .metric-card {
                padding: 12px;
            }
            
            .metric-value {
                font-size: 20px;
            }
            
            .config-section {
                padding: 16px;
                margin-bottom: 15px;
            }
            
            .section-title {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .subsection-title {
                font-size: 15px;
                margin-bottom: 10px;
            }
            
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .scenario-btn {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            .cost-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .revenue-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .loan-model-inputs {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            /* Break-even analysis mobile */
            .break-even-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Sensitivity analysis mobile */
            .sensitivity-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Table responsive */
            .table-container {
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            table {
                font-size: 12px;
                min-width: 700px; /* Ensure table doesn't get too compressed */
            }
            
            th, td {
                padding: 6px 4px !important;
                white-space: nowrap;
            }
            
            /* Sticky header for mobile tables */
            thead th {
                position: sticky;
                top: 0;
                background: #f9fafb;
                z-index: 10;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .summary-item {
                padding: 12px;
            }
            
            .summary-item p:first-child {
                font-size: 12px;
            }
            
            .summary-item p:last-child {
                font-size: 16px;
            }
            
            /* Modal responsive */
            .modal-content {
                margin: 10px;
                padding: 20px;
                max-height: 85vh;
            }
            
            .modal-title {
                font-size: 16px;
            }
            
            /* Input improvements for touch */
            input[type="number"], input[type="range"], select {
                min-height: 44px; /* iOS recommended touch target */
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .input-group input {
                padding: 12px 8px;
            }
            
            /* Info icon touch target */
            .info-icon {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .cost-grid {
                grid-template-columns: 1fr;
            }
            
            .loan-model-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            /* Very small screens - hide some less critical info */
            .metric-sub {
                display: none;
            }
            
            /* Smaller text for tables on very small screens */
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 4px 2px !important;
            }
            
            /* Loan matching section stack vertically */
            .loan-matching-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
        }
        
        /* Touch improvements for all screen sizes */
        .scenario-btn:hover, .scenario-btn:focus {
            transform: scale(1.02);
            transition: transform 0.1s;
        }
        
        input[type="range"] {
            height: 8px;
            -webkit-appearance: none;
            background: #e5e7eb;
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        /* Collapsible sections for mobile */
        .mobile-collapsible {
            display: none;
        }
        
        .mobile-toggle {
            display: none;
            width: 100%;
            padding: 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .mobile-toggle:hover {
            background: #e5e7eb;
        }
        
        .mobile-toggle::after {
            content: " ▼";
            float: right;
            transform: rotate(0deg);
            transition: transform 0.3s;
        }
        
        .mobile-toggle.active::after {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
            }
            
            .mobile-collapsible {
                display: block;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }
            
            .mobile-collapsible.active {
                max-height: 1000px;
            }
        }
        
        .cost-input-large {
            font-size: 28px;
            font-weight: bold;
            width: 120px;
            padding: 5px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-align: center;
        }

        .fixed-cost-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .fixed-cost-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1.2fr;
            gap: 12px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .fixed-cost-inputs {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .fixed-cost-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h1>🚀 Your Business Financial Plan</h1>
                    <p>Build your 3-year plan in 5 simple steps - no finance degree required!</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div>
                        <label style="font-size: 14px; color: #666; margin-bottom: 4px; display: block;">Currency</label>
                        <select id="currencySelect" onchange="changeCurrency()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; background: white;">
                            <option value="USD">🇺🇸 USD</option>
                            <option value="GBP">🇬🇧 GBP</option>
                            <option value="EGP">🇪🇬 EGP</option>
                            <option value="SAR">🇸🇦 SAR</option>
                        </select>
                    </div>
                    <div id="exchangeRateDisplay" style="font-size: 12px; color: #666; text-align: center;">
                        <div>Exchange Rate</div>
                        <div id="rateValue">1.000</div>
                        <div id="lastUpdate" style="font-size: 10px;">Live</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: 600; color: #374151;">Your Progress</span>
                <span style="font-size: 14px; color: #6b7280;" id="progressText">Step 1 of 5</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
            </div>
        </div>
        
        <!-- Step 1: Business Basics -->
        <div class="step-container" id="step1">
            <div class="step-header">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <div class="step-number">1</div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;">Your Business Basics</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">Let's start with the foundation - how fast you want to grow and how much money you're starting with</p>
                    </div>
                </div>
            </div>

            <div class="step-intro">
                <p style="margin: 0; color: #374151; line-height: 1.6;">
                    📈 <strong>Think of this like planning a road trip:</strong> You need to know how fast you want to drive (growth rate) and how much gas money you have (initial funding). Don't worry about being perfect - you can always adjust these later!
                </p>
            </div>

            <div class="step-content">
                <!-- Growth Scenario -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 16px;">🚀 How fast do you want to grow?</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">Pick the growth speed that feels right for your business. Most startups aim for 20-40% monthly growth.</p>
                    <div class="simplified-grid">
                        <div class="simple-card" onclick="selectGrowth('conservative')" data-scenario="conservative">
                            <h4 style="margin: 0 0 8px 0; color: #1f2937;">🐢 Steady & Safe</h4>
                            <div style="font-size: 24px; font-weight: bold; color: #059669; margin-bottom: 8px;">15%</div>
                            <p style="margin: 0; font-size: 14px; color: #6b7280;">Monthly growth</p>
                        </div>
                        <div class="simple-card active" onclick="selectGrowth('base')" data-scenario="base">
                            <h4 style="margin: 0 0 8px 0; color: #1f2937;">🎯 Balanced</h4>
                            <div style="font-size: 24px; font-weight: bold; color: #059669; margin-bottom: 8px;">30%</div>
                            <p style="margin: 0; font-size: 14px; color: #6b7280;">Monthly growth</p>
                        </div>
                        <div class="simple-card" onclick="selectGrowth('aggressive')" data-scenario="aggressive">
                            <h4 style="margin: 0 0 8px 0; color: #1f2937;">🚀 Fast & Bold</h4>
                            <div style="font-size: 24px; font-weight: bold; color: #059669; margin-bottom: 8px;">50%</div>
                            <p style="margin: 0; font-size: 14px; color: #6b7280;">Monthly growth</p>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 16px; background: #f3f4f6; border-radius: 8px;">
                        <p style="margin: 0; color: #4b5563; font-size: 14px;">
                            📊 <strong>With this growth rate:</strong> You'll reach <strong>50,000 users</strong> by the end of Year 1, then continue growing for 3 full years.
                        </p>
                    </div>
                </div>

                <!-- Initial Funding -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 16px;">💰 How much money are you starting with?</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">This is your initial funding - could be savings, investment, or a loan. Don't worry, we'll show you exactly how this gets used.</p>
                    <div style="max-width: 300px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Starting Cash</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                            <input type="number" id="initialFundingStep" value="500000" onchange="updateFunding()" oninput="updateFunding()"
                                   style="width: 100%; padding: 12px 12px 12px 32px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-weight: 600;">
                        </div>
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">💡 Tip: $500,000 is a good starting point for most tech businesses</p>
                    </div>
                </div>

                <button class="next-button" onclick="goToStep(2)">Continue to Step 2: Your Costs →</button>
            </div>
        </div>

        <!-- Step 2: Costs -->
        <div class="step-container" id="step2" style="display: none;">
            <div class="step-header">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <div class="step-number">2</div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;">What You Spend</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">Let's figure out how much it costs to run your business each month</p>
                    </div>
                </div>
            </div>

            <div class="step-intro">
                <p style="margin: 0; color: #374151; line-height: 1.6;">
                    💳 <strong>Every business has two types of costs:</strong> Fixed costs (like rent - same every month) and variable costs (like materials - change based on how many customers you have). We'll keep this simple!
                </p>
            </div>

            <div class="step-content">
                <!-- Variable Costs -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 16px;">📱 Cost Per User (Changes with customer count)</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">These are the API costs that increase as you get more users. Think of it like electricity - the more you use, the more you pay.</p>

                    <div class="cost-per-user-card">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <h3 style="font-size: 18px; margin-bottom: 8px; color: white;">Total Cost Per User (Monthly)</h3>
                                <p style="opacity: 0.9; font-size: 14px; color: rgba(255,255,255,0.9);">
                                    Whisper ($<span id="whisperDisplay">0.450</span>) + GPT-4 ($<span id="gpt4Display">0.105</span>) + Firebase ($<span id="firebaseDisplay">0.003</span>)
                                </p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px;">
                                <span style="font-size: 24px; color: white;">$</span>
                                <input type="number" step="0.001" id="costPerUserQuick" value="0.558" class="cost-input-large"
                                       onchange="updateFromTotalCost()"
                                       title="Edit total cost per user">
                                <span style="font-size: 18px; opacity: 0.9; color: white;">/user</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 16px; padding: 16px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                        <p style="margin: 0; color: #15803d; font-size: 14px;">
                            💡 <strong>What this means:</strong> For every customer you have, you'll pay about $0.56 per month in API costs. So 1,000 customers = $560/month in variable costs.
                        </p>
                    </div>
                </div>

                <!-- Fixed Costs -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 16px;">🏢 Monthly Fixed Costs (Same every month, but grow as you scale)</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">These are your ongoing business expenses. As you grow, you'll need more staff and bigger marketing budgets.</p>

                    <div class="simplified-grid">
                        <div class="simple-card">
                            <h4 style="margin: 0 0 12px 0; color: #1f2937;">👥 Team Salaries</h4>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="color: #6b7280;">$</span>
                                <input type="number" id="salariesStep" value="2000" onchange="updateSalaries()" oninput="updateSalaries()"
                                       style="border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; width: 100px; text-align: center;">
                                <span style="color: #6b7280; font-size: 14px;">/month</span>
                            </div>
                            <p style="margin: 0; font-size: 12px; color: #6b7280;">Currently: $<span id="salariesCurrent">2000</span></p>
                        </div>

                        <div class="simple-card">
                            <h4 style="margin: 0 0 12px 0; color: #1f2937;">📢 Marketing</h4>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="color: #6b7280;">$</span>
                                <input type="number" id="marketingStep" value="1000" onchange="updateMarketing()" oninput="updateMarketing()"
                                       style="border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; width: 100px; text-align: center;">
                                <span style="color: #6b7280; font-size: 14px;">/month</span>
                            </div>
                            <p style="margin: 0; font-size: 12px; color: #6b7280;">Currently: $<span id="marketingCurrent">1000</span></p>
                        </div>

                        <div class="simple-card">
                            <h4 style="margin: 0 0 12px 0; color: #1f2937;">🏠 Office & Other</h4>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="color: #6b7280;">$</span>
                                <input type="number" id="otherStep" value="1000" onchange="updateOther()" oninput="updateOther()"
                                       style="border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; width: 100px; text-align: center;">
                                <span style="color: #6b7280; font-size: 14px;">/month</span>
                            </div>
                            <p style="margin: 0; font-size: 12px; color: #6b7280;">Currently: $<span id="otherCurrent">1000</span></p>
                        </div>
                    </div>

                    <div style="margin-top: 16px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: #92400e; font-size: 14px;">
                            📈 <strong>Smart Growth:</strong> These costs automatically increase as your business grows. More users means you'll need more staff and bigger marketing budgets.
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;" onclick="goToStep(1)">← Back</button>
                    <button class="next-button" onclick="goToStep(3)">Continue to Step 3: Your Revenue →</button>
                </div>

                <!-- Hidden inputs needed for calculations -->
                <div style="display: none;">
                    <input type="number" step="0.001" id="whisperCost" value="0.45" onchange="debouncedUpdate()">
                    <input type="number" step="0.001" id="gpt4Cost" value="0.105" onchange="debouncedUpdate()">
                    <input type="number" step="0.001" id="firebaseCost" value="0.003" onchange="debouncedUpdate()">
                    <input type="number" id="totalVariableCost" value="0.558">
                    <input type="number" step="0.1" id="salariesGrowth" value="0.5" onchange="debouncedUpdate()">
                    <input type="number" id="salariesThreshold" value="1000" onchange="debouncedUpdate()">
                    <input type="number" id="office" value="0" onchange="debouncedUpdate()">
                    <input type="number" step="0.1" id="officeGrowth" value="0.3" onchange="debouncedUpdate()">
                    <input type="number" id="officeThreshold" value="2000" onchange="debouncedUpdate()">
                    <input type="number" step="0.1" id="marketingGrowth" value="0.4" onchange="debouncedUpdate()">
                    <input type="number" id="marketingThreshold" value="1500" onchange="debouncedUpdate()">
                    <input type="number" step="0.1" id="otherGrowth" value="0.2" onchange="debouncedUpdate()">
                    <input type="number" id="otherThreshold" value="2500" onchange="debouncedUpdate()">
                    <input type="number" id="userReach1" value="20" onchange="debouncedUpdate()">
                    <input type="number" id="successRate1" value="15" onchange="debouncedUpdate()">
                    <input type="number" id="userReach2" value="10" onchange="debouncedUpdate()">
                    <input type="number" id="successRate2" value="10" onchange="debouncedUpdate()">
                    <input type="number" id="customRate" value="30" onchange="debouncedUpdate()">
                </div>
            </div>
        </div>

        <!-- Step 3: Revenue -->
        <div class="step-container" id="step3" style="display: none;">
            <div class="step-header">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <div class="step-number">3</div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;">How You Make Money</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">Now let's set up your revenue streams - the ways customers pay you</p>
                    </div>
                </div>
            </div>

            <div class="step-intro">
                <p style="margin: 0; color: #374151; line-height: 1.6;">
                    💰 <strong>Think of revenue like different taps filling a bucket:</strong> You can have multiple ways money flows into your business. Most successful businesses have 2-3 main revenue streams.
                </p>
            </div>

            <div class="step-content">
                <!-- Premium Subscriptions -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 16px;">💳 Premium Subscriptions</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">Your main revenue stream - customers paying monthly for premium features.</p>

                    <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 8px; padding: 20px;">
                        <div class="simplified-grid" style="grid-template-columns: 1fr 1fr;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Monthly Price</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280;">$</span>
                                    <input type="number" step="0.01" id="premiumPriceStep" value="3.00" onchange="updatePremiumPrice()" oninput="updatePremiumPrice()"
                                           style="border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; width: 100px; text-align: center; font-weight: 600;">
                                    <span style="color: #6b7280; font-size: 14px;">/month</span>
                                </div>
                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">💡 $3-10 is typical for SME tools</p>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Conversion Rate</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="premiumConversionStep" value="20" onchange="updatePremiumConversion()" oninput="updatePremiumConversion()"
                                           style="border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; width: 100px; text-align: center; font-weight: 600;">
                                    <span style="color: #6b7280; font-size: 14px;">% of users pay</span>
                                </div>
                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #6b7280;">💡 15-25% is typical for freemium</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loan Matching -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1f2937; margin-bottom: 16px;">🏦 Loan Matching Revenue</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">Earn commissions by connecting your users with loan providers. Two different market approaches:</p>

                    <div style="display: grid; gap: 20px;">
                        <!-- Microloan Model -->
                        <div style="background: #e0f2fe; border: 2px solid #0284c7; border-radius: 8px; padding: 16px;">
                            <h4 style="color: #0369a1; margin: 0 0 12px 0;">🌍 Microloans (Developing Markets)</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #0369a1;">Average Loan Size</label>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span style="font-size: 12px;">$</span>
                                        <input type="number" id="loanSize1Step" value="2000" onchange="updateLoanSize1()" oninput="updateLoanSize1()" style="padding: 4px; width: 80px; text-align: center;">
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #0369a1;">Commission %</label>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" step="0.1" id="commission1Step" value="0.5" onchange="updateCommission1()" oninput="updateCommission1()" style="padding: 4px; width: 60px; text-align: center;">
                                        <span style="font-size: 12px;">%</span>
                                    </div>
                                </div>
                            </div>
                            <p style="margin: 8px 0 0 0; font-size: 11px; color: #0369a1;">Commission per loan: $<span id="commissionPerLoan1">10</span></p>
                        </div>

                        <!-- SME Model -->
                        <div style="background: #dcfce7; border: 2px solid #16a34a; border-radius: 8px; padding: 16px;">
                            <h4 style="color: #14532d; margin: 0 0 12px 0;">🏢 SME Loans (Standard Markets)</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #14532d;">Average Loan Size</label>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span style="font-size: 12px;">$</span>
                                        <input type="number" id="loanSize2" value="5000" onchange="debouncedUpdate()" oninput="debouncedUpdate()" style="padding: 4px; width: 80px; text-align: center;">
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #14532d;">Commission %</label>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" step="0.1" id="commission2" value="0.5" onchange="debouncedUpdate()" oninput="debouncedUpdate()" style="padding: 4px; width: 60px; text-align: center;">
                                        <span style="font-size: 12px;">%</span>
                                    </div>
                                </div>
                            </div>
                            <p style="margin: 8px 0 0 0; font-size: 11px; color: #14532d;">Commission per loan: $<span id="commissionPerLoan2">25</span></p>
                        </div>
                    </div>

                    <div style="margin-top: 16px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: #92400e; font-size: 14px;">
                            🎯 <strong>Revenue Potential:</strong> Total monthly loan revenue: $<span id="totalLoanRevenue">0</span> (this grows automatically as you get more users)
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;" onclick="goToStep(2)">← Back</button>
                    <button class="next-button" onclick="goToStep(4)">Continue to Step 4: Your Results →</button>
                </div>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div class="step-container" id="step4" style="display: none;">
            <div class="step-header">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <div class="step-number">4</div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;">Your 3-Year Financial Picture</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">Here's what your business looks like over the next 3 years</p>
                    </div>
                </div>
            </div>

            <div class="step-intro">
                <p style="margin: 0; color: #374151; line-height: 1.6;">
                    📊 <strong>This is like your business crystal ball:</strong> Based on your inputs, here's how much money you'll make, spend, and keep over 3 years. These numbers update automatically as you change your settings.
                </p>
            </div>

            <div class="step-content">
                <!-- Executive Summary Cards -->
                <div class="summary-grid" style="margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💰 Total Revenue (3 Years)</div>
                        <div style="font-size: 28px; font-weight: bold;" id="total3YearRevenue">$2.5M</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Money coming in from customers</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">👥 Final User Base</div>
                        <div style="font-size: 28px; font-weight: bold;" id="final3YearUsers">450K</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Total customers by end of Year 3</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9333ea, #7c3aed); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">📊 Net Profit (3 Years)</div>
                        <div style="font-size: 28px; font-weight: bold;" id="total3YearProfit">$850K</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Money left after all expenses</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💳 Monthly Revenue (Y3)</div>
                        <div style="font-size: 28px; font-weight: bold;" id="final3YearMonthlyRevenue">$135K</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Monthly income by Year 3 end</div>
                    </div>
                </div>

                <!-- Quick Metrics -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <h4 style="margin: 0 0 16px 0; color: #1f2937;">📈 Key Milestones</h4>
                    <div class="simplified-grid">
                        <div class="simple-card">
                            <h5 style="margin: 0 0 8px 0; color: #1f2937;">💡 Break-Even Point</h5>
                            <div style="font-size: 20px; font-weight: bold; color: #059669;" id="profitableMonth">Month 8</div>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">When you start making profit</p>
                        </div>
                        <div class="simple-card">
                            <h5 style="margin: 0 0 8px 0; color: #1f2937;">💰 Cash Runway</h5>
                            <div style="font-size: 20px; font-weight: bold; color: #059669;" id="runway">24+ months</div>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">How long your money lasts</p>
                        </div>
                        <div class="simple-card">
                            <h5 style="margin: 0 0 8px 0; color: #1f2937;">📊 Revenue Per User</h5>
                            <div style="font-size: 20px; font-weight: bold; color: #059669;" id="arpu">$2.40</div>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">Monthly revenue per customer</p>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;" onclick="goToStep(3)">← Back</button>
                    <button class="next-button" onclick="goToStep(5)">Continue to Step 5: Conclusion →</button>
                </div>
            </div>
        </div>

        <!-- Step 5: Conclusion -->
        <div class="step-container" id="step5" style="display: none;">
            <div class="step-header">
                <div style="display: flex; align-items: center; justify-content: center;">
                    <div class="step-number">5</div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;">Your Action Plan</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9;">What to focus on next to make this plan reality</p>
                    </div>
                </div>
            </div>

            <div class="step-content">
                <div class="conclusion-box">
                    <h3 style="margin: 0 0 16px 0; font-size: 24px;">🎉 Congratulations!</h3>
                    <p style="margin: 0 0 16px 0; font-size: 18px; opacity: 0.9;">You've built a complete 3-year financial plan for your business</p>

                    <div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 16px; margin: 20px 0;">
                        <h4 style="margin: 0 0 12px 0;">📋 Your Plan Summary:</h4>
                        <ul style="margin: 0; padding-left: 20px; text-align: left;">
                            <li>Start with <strong id="startingCash">$500,000</strong> in funding</li>
                            <li>Reach profitability in <strong id="breakEvenTime">Month 8</strong></li>
                            <li>Generate <strong id="totalRevenue3Y">$2.5M</strong> revenue over 3 years</li>
                            <li>Build a user base of <strong id="finalUsers3Y">450,000</strong> customers</li>
                            <li>Create <strong id="totalProfit3Y">$850K</strong> in net profit</li>
                        </ul>
                    </div>
                </div>

                <!-- Next Steps -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 20px 0;">
                    <h4 style="margin: 0 0 16px 0; color: #1f2937;">🚀 Next Steps to Success</h4>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <div style="background: #10b981; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">1</div>
                            <div>
                                <h5 style="margin: 0 0 4px 0; color: #1f2937;">Validate Your Assumptions</h5>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">Test your pricing and conversion rates with real customers. Start small and adjust.</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <div style="background: #10b981; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">2</div>
                            <div>
                                <h5 style="margin: 0 0 4px 0; color: #1f2937;">Focus on Customer Acquisition</h5>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">Your growth depends on getting those first 1,000 users. Invest heavily in marketing and product-market fit.</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <div style="background: #10b981; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">3</div>
                            <div>
                                <h5 style="margin: 0 0 4px 0; color: #1f2937;">Monitor Cash Flow Monthly</h5>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">Track your actual vs. projected numbers every month. Adjust spending if you're burning cash faster than expected.</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <div style="background: #10b981; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">4</div>
                            <div>
                                <h5 style="margin: 0 0 4px 0; color: #1f2937;">Build Revenue Diversification</h5>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">Don't rely on just one revenue stream. Develop both subscription and loan matching revenue early.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="text-align: center; margin-top: 30px;">
                    <button style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 12px;" onclick="goToStep(4)">← Back to Results</button>
                    <button class="next-button" onclick="showDetailedView()">View Detailed Financial Breakdown →</button>
                </div>
            </div>
        </div>

        <!-- Final P&L View (shown after Step 5) -->
        <div id="finalPLView" style="display: none;">
            <!-- Header -->
            <div class="header" style="margin-bottom: 24px;">
                <div style="text-align: center;">
                    <h1>📊 Your Complete Financial Plan</h1>
                    <p>3-Year Monthly P&L Breakdown - Ready for Action</p>
                </div>
            </div>

            <!-- Executive Summary Cards -->
            <div class="summary-grid" style="margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💰 Total Revenue (3 Years)</div>
                    <div style="font-size: 28px; font-weight: bold;" id="total3YearRevenueFinal">$2.5M</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Money coming in from customers</div>
                </div>
                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">👥 Final User Base</div>
                    <div style="font-size: 28px; font-weight: bold;" id="final3YearUsersFinal">450K</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Total customers by end of Year 3</div>
                </div>
                <div style="background: linear-gradient(135deg, #9333ea, #7c3aed); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">📊 Net Profit (3 Years)</div>
                    <div style="font-size: 28px; font-weight: bold;" id="total3YearProfitFinal">$850K</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Money left after all expenses</div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💳 Monthly Revenue (Y3)</div>
                    <div style="font-size: 28px; font-weight: bold;" id="final3YearMonthlyRevenueFinal">$135K</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Monthly income by Year 3 end</div>
                </div>
            </div>

            <!-- Download Section -->
            <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 24px; text-align: center;">
                <h3 style="margin: 0 0 16px 0; color: #1f2937;">📁 Save Your Plan</h3>
                <p style="margin: 0 0 20px 0; color: #6b7280;">Download your complete financial plan as an Excel spreadsheet with all details included.</p>
                <button onclick="downloadExcel()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 16px 32px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-right: 12px;">
                    📥 Download Excel File
                </button>
                <button onclick="goBackToSteps()" style="background: #6b7280; color: white; border: none; padding: 16px 32px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                    ← Back to Steps
                </button>
            </div>

            <!-- Monthly P&L Breakdown -->
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="background: linear-gradient(to right, #1f2937, #374151); color: white; padding: 20px; text-align: center;">
                    <h3 style="margin: 0; font-size: 24px;">📅 36-Month P&L Breakdown</h3>
                    <p style="margin: 8px 0 0 0; opacity: 0.9;">Complete month-by-month financial performance</p>
                </div>

                <div class="table-container" style="overflow-x: auto; max-height: 70vh; overflow-y: auto;">
                    <table id="finalPLTable" style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10;">
                            <tr>
                                <th style="text-align: left; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Month</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Users</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Revenue</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Variable Costs</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Fixed Costs</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Total Costs</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Gross Profit</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Net Profit</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cash Position</th>
                                <th style="text-align: right; padding: 12px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">ARPU</th>
                            </tr>
                        </thead>
                        <tbody id="finalPLTableBody">
                            <!-- Detailed P&L rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- CAC Info Modal -->
    <div id="cacModal" class="modal-overlay" onclick="closeCACModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">💰 Customer Acquisition Cost (CAC)</h3>
                <button class="modal-close" onclick="closeCACModal()">&times;</button>
            </div>
            
            <div style="color: #4b5563; line-height: 1.6;">
                <p><strong>Customer Acquisition Cost (CAC)</strong> measures how much it costs to acquire each new paying customer.</p>
                
                <div class="formula-box">
                    <strong>CAC = Marketing Spend ÷ Number of New Users</strong>
                </div>
                
                <h4 style="margin: 20px 0 12px 0; color: #1f2937;">How it's calculated in this model:</h4>
                
                <div class="example-box">
                    <p><strong>Example Calculation:</strong></p>
                    <ul style="margin: 12px 0; padding-left: 20px;">
                        <li><span class="highlight">Marketing Budget:</span> $1,000/month</li>
                        <li><span class="highlight">Total Users:</span> 50,000 users</li>
                        <li><span class="highlight">CAC:</span> $1,000 ÷ 50,000 = $0.02 per user</li>
                    </ul>
                </div>
                
                <h4 style="margin: 20px 0 12px 0; color: #1f2937;">Key Insights:</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li><strong>Lower is better:</strong> Less cost per customer means better efficiency</li>
                    <li><strong>Compare to LTV:</strong> CAC should be much lower than Customer Lifetime Value</li>
                    <li><strong>Track over time:</strong> CAC often increases as you scale marketing</li>
                    <li><strong>Channel-specific:</strong> Different marketing channels have different CACs</li>
                </ul>
                
                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #92400e;">
                        <strong>💡 Pro Tip:</strong> A good SaaS business typically has an LTV:CAC ratio of 3:1 or higher, meaning customers generate at least 3x their acquisition cost.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentScenario = 'base';
        const growthRates = {
            conservative: 15,
            base: 30,
            aggressive: 50,
            custom: 30
        };
        
        // Performance optimizations
        let updateTimeout;
        let lastInputHash = '';
        let cachedProjections = null;
        let lastTableData = null;
        
        // Multi-currency support
        let currentCurrency = 'USD';
        let exchangeRates = { USD: 1, GBP: 0.79, EGP: 30.85, SAR: 3.75 };
        let lastRateUpdate = 0;
        
        
        
        // Debounced update function
        function debouncedUpdate() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updateModel, 300);
        }
        
        // Input validation function
        function validateInput(element, min = 0, max = Infinity) {
            let value = parseFloat(element.value);
            if (isNaN(value) || value < min) value = min;
            if (value > max) value = max;
            element.value = value;
            return value;
        }

        // Calculate compound growth for fixed costs
        function calculateCompoundGrowth(baseAmount, growthRate, threshold, currentUsers) {
            if (threshold <= 0 || currentUsers <= 0) return baseAmount;
            const growthMultiplier = currentUsers / threshold;
            return baseAmount * Math.pow(1 + (growthRate / 100), growthMultiplier);
        }

        // Update current cost displays
        function updateFixedCostDisplays(users) {
            const salariesBase = parseFloat(document.getElementById('salaries').value) || 0;
            const salariesGrowth = parseFloat(document.getElementById('salariesGrowth').value) || 0;
            const salariesThreshold = parseFloat(document.getElementById('salariesThreshold').value) || 1000;
            const currentSalaries = calculateCompoundGrowth(salariesBase, salariesGrowth, salariesThreshold, users);
            document.getElementById('salariesCurrent').textContent = Math.round(currentSalaries);

            const officeBase = parseFloat(document.getElementById('office').value) || 0;
            const officeGrowth = parseFloat(document.getElementById('officeGrowth').value) || 0;
            const officeThreshold = parseFloat(document.getElementById('officeThreshold').value) || 1000;
            const currentOffice = calculateCompoundGrowth(officeBase, officeGrowth, officeThreshold, users);
            document.getElementById('officeCurrent').textContent = Math.round(currentOffice);

            const marketingBase = parseFloat(document.getElementById('marketing').value) || 0;
            const marketingGrowth = parseFloat(document.getElementById('marketingGrowth').value) || 0;
            const marketingThreshold = parseFloat(document.getElementById('marketingThreshold').value) || 1000;
            const currentMarketing = calculateCompoundGrowth(marketingBase, marketingGrowth, marketingThreshold, users);
            document.getElementById('marketingCurrent').textContent = Math.round(currentMarketing);

            const otherBase = parseFloat(document.getElementById('other').value) || 0;
            const otherGrowth = parseFloat(document.getElementById('otherGrowth').value) || 0;
            const otherThreshold = parseFloat(document.getElementById('otherThreshold').value) || 1000;
            const currentOther = calculateCompoundGrowth(otherBase, otherGrowth, otherThreshold, users);
            document.getElementById('otherCurrent').textContent = Math.round(currentOther);
        }
        
        // Generate hash of all inputs for caching
        function getInputHash() {
            const inputs = document.querySelectorAll('input[type="number"]');
            return Array.from(inputs).map(i => i.value).join('|') + currentScenario;
        }
        
        // Currency conversion functions
        async function fetchExchangeRates() {
            try {
                // Using a free API for exchange rates (fallback to static rates if fails)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    // Only update rates for our supported currencies
                    const newRates = {
                        USD: 1,
                        GBP: data.rates.GBP || 0.79,
                        EGP: data.rates.EGP || 30.85,
                        SAR: data.rates.SAR || 3.75
                    };
                    exchangeRates = newRates;
                    lastRateUpdate = Date.now();
                    document.getElementById('lastUpdate').textContent = 'Live';
                    
                    // Update displayed rate if needed
                    document.getElementById('rateValue').textContent = (exchangeRates[currentCurrency] || 1).toFixed(3);
                }
            } catch (error) {
                console.log('Using cached exchange rates:', error.name);
                document.getElementById('lastUpdate').textContent = 'Cached';
            }
        }
        
        function formatCurrency(value) {
            const rate = exchangeRates[currentCurrency] || 1;
            const convertedValue = value * rate;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currentCurrency,
                minimumFractionDigits: currentCurrency === 'EGP' ? 0 : 2,
                maximumFractionDigits: currentCurrency === 'EGP' ? 0 : 2
            }).format(convertedValue);
        }
        
        function convertFromUSD(usdValue) {
            const rate = exchangeRates[currentCurrency] || 1;
            return usdValue * rate;
        }
        
        function convertToUSD(localValue) {
            const rate = exchangeRates[currentCurrency] || 1;
            return localValue / rate;
        }
        
        function changeCurrency() {
            currentCurrency = document.getElementById('currencySelect').value;
            document.getElementById('rateValue').textContent = (exchangeRates[currentCurrency] || 1).toFixed(3);
            
            // Update rate if older than 1 hour
            if (Date.now() - lastRateUpdate > 3600000) {
                fetchExchangeRates();
            }
            
            debouncedUpdate();
        }
        
        // Break-even analysis functions
        function calculateBreakEven(fixedCosts, variableCostPerUser, revenuePerUser) {
            const contributionMargin = revenuePerUser - variableCostPerUser;
            if (contributionMargin <= 0) return { users: Infinity, revenue: Infinity, months: Infinity };
            
            const breakEvenUsers = Math.ceil(fixedCosts / contributionMargin);
            const breakEvenRevenue = breakEvenUsers * revenuePerUser;
            
            return {
                users: breakEvenUsers,
                revenue: breakEvenRevenue,
                contributionMargin: contributionMargin
            };
        }
        
        function calculateUnitEconomics(marketingCost, users, revenuePerUser, variableCostPerUser) {
            const cac = users > 0 ? marketingCost / users : 0;
            const ltv = revenuePerUser * 24; // Assuming 24 month LTV
            const ltvCacRatio = cac > 0 ? ltv / cac : 0;
            const contributionMargin = revenuePerUser - variableCostPerUser;
            const paybackPeriod = cac > 0 && contributionMargin > 0 ? cac / contributionMargin : 0;
            
            return { cac, ltv, ltvCacRatio, paybackPeriod };
        }
        
        // Sensitivity analysis
        function updateSensitivity() {
            const conversionRate = document.getElementById('sensitivityConversionSlider').value;
            const growthRate = document.getElementById('sensitivityGrowthSlider').value;
            const costPerUser = document.getElementById('sensitivityCostSlider').value;
            
            document.getElementById('sensitivityConversion').textContent = conversionRate + '%';
            document.getElementById('sensitivityGrowth').textContent = growthRate + '%';
            document.getElementById('sensitivityCost').textContent = formatCurrency(parseFloat(costPerUser));
            
            // Simulate break-even with these parameters
            const premiumPrice = parseFloat(document.getElementById('premiumPrice').value) || 3.00;
            const revenuePerUser = (premiumPrice * conversionRate / 100);
            const fixedCosts = 4000; // Total fixed costs from form (2000 + 0 + 1000 + 1000)
            
            const breakEven = calculateBreakEven(fixedCosts, parseFloat(costPerUser), revenuePerUser);
            const monthsToBreakEven = Math.ceil(Math.log(breakEven.users / 1000) / Math.log(1 + growthRate / 100));
            
            document.getElementById('sensitivityImpact').textContent = 
                `Break-even in ${monthsToBreakEven} months with ${breakEven.users.toLocaleString()} users`;
        }
        
        
        // Update loan displays function (moved outside updateModel)
        function updateLoanDisplays(users) {
            const loanSize1 = parseFloat(document.getElementById('loanSize1').value) || 2000;
            const commission1 = parseFloat(document.getElementById('commission1').value) || 0.5;
            const userReach1 = parseFloat(document.getElementById('userReach1').value) || 20;
            const successRate1 = parseFloat(document.getElementById('successRate1').value) || 15;
            
            const loanSize2 = parseFloat(document.getElementById('loanSize2').value) || 5000;
            const commission2 = parseFloat(document.getElementById('commission2').value) || 0.5;
            const userReach2 = parseFloat(document.getElementById('userReach2').value) || 10;
            const successRate2 = parseFloat(document.getElementById('successRate2').value) || 10;
            
            const eligibleUsers1 = users * (userReach1 / 100) * (successRate1 / 100);
            const loansMonth1 = eligibleUsers1 * 0.1;
            const commissionPerLoan1 = loanSize1 * (commission1 / 100);
            const loanRevenue1 = loansMonth1 * commissionPerLoan1;
            
            const eligibleUsers2 = users * (userReach2 / 100) * (successRate2 / 100);
            const loansMonth2 = eligibleUsers2 * 0.1;
            const commissionPerLoan2 = loanSize2 * (commission2 / 100);
            const loanRevenue2 = loansMonth2 * commissionPerLoan2;
            
            document.getElementById('commissionPerLoan1').textContent = formatCurrency(commissionPerLoan1);
            document.getElementById('loansPerMonth1').textContent = loansMonth1.toFixed(1);
            document.getElementById('loanRevenue1').textContent = formatCurrency(Math.round(loanRevenue1));
            
            document.getElementById('commissionPerLoan2').textContent = formatCurrency(commissionPerLoan2);
            document.getElementById('loansPerMonth2').textContent = loansMonth2.toFixed(1);
            document.getElementById('loanRevenue2').textContent = formatCurrency(Math.round(loanRevenue2));
            
            document.getElementById('totalLoanRevenue').textContent = formatCurrency(Math.round(loanRevenue1 + loanRevenue2));
        }
        
        function updateBreakEvenAnalysis(data) {
            const {projections, lastMonth, variableCostPerUser} = data;

            // Get current inputs
            const premiumPrice = parseFloat(document.getElementById('premiumPrice').value) || 3.00;
            const premiumConversion = parseFloat(document.getElementById('premiumConversion').value) || 20;
            const revenuePerUser = (premiumPrice * premiumConversion / 100);

            // For break-even with dynamic costs, we need to find it from projections
            let breakEvenMonth = null;
            let breakEvenUsers = 0;
            let breakEvenRevenue = 0;

            for (let i = 0; i < projections.length; i++) {
                if (projections[i].profit >= 0) {
                    breakEvenMonth = i + 1;
                    breakEvenUsers = projections[i].users;
                    breakEvenRevenue = projections[i].revenue;
                    break;
                }
            }

            // Calculate unit economics using current marketing costs
            const currentMarketing = calculateCompoundGrowth(
                parseFloat(document.getElementById('marketing').value) || 0,
                parseFloat(document.getElementById('marketingGrowth').value) || 0,
                parseFloat(document.getElementById('marketingThreshold').value) || 1000,
                lastMonth.users
            );

            const unitEcon = calculateUnitEconomics(currentMarketing, lastMonth.users, revenuePerUser, variableCostPerUser);

            // Update UI
            document.getElementById('breakEvenUsers').textContent = breakEvenUsers > 0 ? breakEvenUsers.toLocaleString() : '>150K';
            document.getElementById('breakEvenRevenue').textContent = breakEvenRevenue > 0 ? formatCurrency(breakEvenRevenue) : 'N/A';
            document.getElementById('monthsToBreakEven').textContent = breakEvenMonth || '>24';

            document.getElementById('cac').textContent = formatCurrency(unitEcon.cac);
            document.getElementById('ltvCacRatio').textContent = unitEcon.ltvCacRatio.toFixed(1) + 'x';
            document.getElementById('paybackPeriod').textContent = unitEcon.paybackPeriod.toFixed(1);
        }
        
        // Modal functions
        function showCACModal() {
            document.body.style.cursor = 'default'; // Ensure cursor is normal
            document.getElementById('cacModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeCACModal(event) {
            if (!event || event.target.id === 'cacModal') {
                document.body.style.cursor = 'default'; // Ensure cursor is normal
                document.getElementById('cacModal').style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCACModal();
            }
        });
        
        // Ensure cursor is always reset when interacting with modal
        document.addEventListener('click', function() {
            // Small delay to ensure any loading states are processed
            setTimeout(() => {
                if (document.getElementById('cacModal').style.display !== 'flex') {
                    document.body.style.cursor = 'default';
                }
            }, 50);
        });
        
        // Mobile collapsible functionality
        function toggleMobileSection(element) {
            element.classList.toggle('active');
            const targetId = element.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.toggle('active');
            }
        }
        
        // Initialize mobile toggles
        document.addEventListener('DOMContentLoaded', function() {
            const toggles = document.querySelectorAll('.mobile-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    toggleMobileSection(this);
                });
            });
        });
        
        function updateFromTotalCost() {
            const newTotalCost = parseFloat(document.getElementById('costPerUserQuick').value) || 0.558;
            const whisperCost = parseFloat(document.getElementById('whisperCost').value) || 0.45;
            const gpt4Cost = parseFloat(document.getElementById('gpt4Cost').value) || 0.105;
            const firebaseCost = parseFloat(document.getElementById('firebaseCost').value) || 0.003;
            const currentTotal = whisperCost + gpt4Cost + firebaseCost;
            
            if (currentTotal > 0) {
                const whisperRatio = whisperCost / currentTotal;
                const gpt4Ratio = gpt4Cost / currentTotal;
                const firebaseRatio = firebaseCost / currentTotal;
                
                document.getElementById('whisperCost').value = (newTotalCost * whisperRatio).toFixed(3);
                document.getElementById('gpt4Cost').value = (newTotalCost * gpt4Ratio).toFixed(3);
                document.getElementById('firebaseCost').value = (newTotalCost * firebaseRatio).toFixed(3);
            }
            
            debouncedUpdate();
        }
        
        function setScenario(scenario) {
            currentScenario = scenario;
            
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-scenario="${scenario}"]`).classList.add('active');
            
            document.getElementById('customRateInput').style.display = 
                scenario === 'custom' ? 'block' : 'none';
            
            const rate = scenario === 'custom' ? 
                parseFloat(document.getElementById('customRate').value) : 
                growthRates[scenario];
            document.getElementById('currentGrowthRate').textContent = rate;
            
            debouncedUpdate();
        }
        
        function updateModel() {
            // Add loading state
            document.body.style.cursor = 'wait';
            
            // Check if inputs changed (memoization)
            const currentHash = getInputHash();
            if (currentHash === lastInputHash && cachedProjections) {
                updateUI(cachedProjections);
                document.body.style.cursor = 'default';
                return;
            }
            
            // Get all inputs with validation - prioritize step inputs
            const customRate = validateInput(document.getElementById('customRate'), 1, 200);

            // Read funding from step input first, then hidden input
            const initialFundingStep = document.getElementById('initialFundingStep')?.value;
            const initialFundingHidden = document.getElementById('initialFunding')?.value;
            const initialFundingValue = initialFundingStep || initialFundingHidden || '500000';

            // Ensure the hidden input has the correct value before validation
            document.getElementById('initialFunding').value = initialFundingValue;
            const initialFunding = validateInput(document.getElementById('initialFunding'), 0, 10000000);
            console.log('updateModel - Step funding:', initialFundingStep, 'Hidden:', initialFundingHidden, 'Using:', initialFunding);
            
            const whisperCost = validateInput(document.getElementById('whisperCost'), 0, 10);
            const gpt4Cost = validateInput(document.getElementById('gpt4Cost'), 0, 10);
            const firebaseCost = validateInput(document.getElementById('firebaseCost'), 0, 10);
            const variableCostPerUser = whisperCost + gpt4Cost + firebaseCost;
            
            // Update displays
            document.getElementById('totalVariableCost').value = variableCostPerUser.toFixed(3);
            document.getElementById('costPerUserQuick').value = variableCostPerUser.toFixed(3);
            document.getElementById('whisperDisplay').textContent = whisperCost.toFixed(3);
            document.getElementById('gpt4Display').textContent = gpt4Cost.toFixed(3);
            document.getElementById('firebaseDisplay').textContent = firebaseCost.toFixed(3);
            
            const salariesBase = validateInput(document.getElementById('salaries'), 0, 1000000);
            const salariesGrowth = validateInput(document.getElementById('salariesGrowth'), 0, 50);
            const salariesThreshold = validateInput(document.getElementById('salariesThreshold'), 1, 100000);

            const officeBase = validateInput(document.getElementById('office'), 0, 100000);
            const officeGrowth = validateInput(document.getElementById('officeGrowth'), 0, 50);
            const officeThreshold = validateInput(document.getElementById('officeThreshold'), 1, 100000);

            const marketingBase = validateInput(document.getElementById('marketing'), 0, 500000);
            const marketingGrowth = validateInput(document.getElementById('marketingGrowth'), 0, 50);
            const marketingThreshold = validateInput(document.getElementById('marketingThreshold'), 1, 100000);

            const otherBase = validateInput(document.getElementById('other'), 0, 100000);
            const otherGrowth = validateInput(document.getElementById('otherGrowth'), 0, 50);
            const otherThreshold = validateInput(document.getElementById('otherThreshold'), 1, 100000);
            
            const premiumPrice = validateInput(document.getElementById('premiumPrice'), 0, 1000);
            const premiumConversion = validateInput(document.getElementById('premiumConversion'), 0, 100);
            
            const loanSize1 = validateInput(document.getElementById('loanSize1'), 100, 1000000);
            const commission1 = validateInput(document.getElementById('commission1'), 0, 10);
            const userReach1 = validateInput(document.getElementById('userReach1'), 0, 100);
            const successRate1 = validateInput(document.getElementById('successRate1'), 0, 100);
            
            const loanSize2 = validateInput(document.getElementById('loanSize2'), 100, 1000000);
            const commission2 = validateInput(document.getElementById('commission2'), 0, 10);
            const userReach2 = validateInput(document.getElementById('userReach2'), 0, 100);
            const successRate2 = validateInput(document.getElementById('successRate2'), 0, 100);
            
            document.getElementById('customRateDisplay').textContent = customRate;
            const currentRate = currentScenario === 'custom' ? customRate : growthRates[currentScenario];
            document.getElementById('currentGrowthRate').textContent = currentRate;
            growthRates.custom = customRate;
            
            // Calculate projections for 36 months (3 years)
            const months = 36;
            const targetYear1Users = 50000;
            const growthRate = growthRates[currentScenario] / 100;
            const startingUsers = targetYear1Users / Math.pow(1 + growthRate, 11);
            
            let cashPosition = initialFunding;
            const projections = [];
            let totalBurn = 0;
            let firstProfitableMonth = null;

            for (let i = 1; i <= months; i++) {
                const users = Math.round(startingUsers * Math.pow(1 + growthRate, i - 1));

                // Calculate compound growth for each fixed cost category
                const currentSalaries = calculateCompoundGrowth(salariesBase, salariesGrowth, salariesThreshold, users);
                const currentOffice = calculateCompoundGrowth(officeBase, officeGrowth, officeThreshold, users);
                const currentMarketing = calculateCompoundGrowth(marketingBase, marketingGrowth, marketingThreshold, users);
                const currentOther = calculateCompoundGrowth(otherBase, otherGrowth, otherThreshold, users);

                const fixedCosts = currentSalaries + currentOffice + currentMarketing + currentOther;
                const variableCosts = users * variableCostPerUser;
                const totalCosts = variableCosts + fixedCosts;
                
                const premiumUsers = users * (premiumConversion / 100);
                const premiumRevenue = premiumUsers * premiumPrice;
                
                const eligibleUsers1 = users * (userReach1 / 100) * (successRate1 / 100);
                const loansMonth1 = eligibleUsers1 * 0.1;
                const commissionPerLoan1 = loanSize1 * (commission1 / 100);
                const loanRevenue1 = loansMonth1 * commissionPerLoan1;
                
                const eligibleUsers2 = users * (userReach2 / 100) * (successRate2 / 100);
                const loansMonth2 = eligibleUsers2 * 0.1;
                const commissionPerLoan2 = loanSize2 * (commission2 / 100);
                const loanRevenue2 = loansMonth2 * commissionPerLoan2;
                
                const totalLoanRevenue = loanRevenue1 + loanRevenue2;
                const totalRevenue = premiumRevenue + totalLoanRevenue;
                
                const profit = totalRevenue - totalCosts;
                
                if (profit >= 0 && firstProfitableMonth === null) {
                    firstProfitableMonth = i;
                }
                
                if (profit < 0) {
                    totalBurn += Math.abs(profit);
                }
                
                cashPosition += profit;
                
                const arpu = users > 0 ? totalRevenue / users : 0;
                
                projections.push({
                    month: i,
                    users: users,
                    revenue: Math.round(totalRevenue),
                    costs: Math.round(totalCosts),
                    profit: Math.round(profit),
                    cashPosition: Math.round(cashPosition),
                    arpu: arpu.toFixed(2)
                });
            }
            
            // Cache results and update UI
            lastInputHash = currentHash;
            cachedProjections = {
                projections,
                lastMonth: projections[projections.length - 1],
                year1Month: projections[11],
                totalBurn,
                firstProfitableMonth,
                variableCostPerUser
            };
            
            updateUI(cachedProjections);
            document.body.style.cursor = 'default';
        }
        
        // Optimized table update function for 36 months
        function updateTableIfChanged(projections, year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit, lastMonth) {
            try {
                // Calculate year 3 totals
                let year3Revenue = 0, year3Costs = 0, year3Profit = 0;
                projections.slice(24, 36).forEach(proj => {
                    year3Revenue += proj.revenue;
                    year3Costs += proj.costs;
                    year3Profit += proj.profit;
                });

                const tableData = JSON.stringify({projections, year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit, year3Revenue, year3Costs, year3Profit});
                if (tableData === lastTableData) return;
                lastTableData = tableData;

                // Update table
                const tbody = document.getElementById('projectionsTable');
                if (!tbody) {
                    console.error('Table body not found');
                    return;
                }
                tbody.innerHTML = '';

            projections.forEach((proj, index) => {
                // Year 1 Summary
                if (index === 12) {
                    const summaryRow = tbody.insertRow();
                    summaryRow.style.background = '#fbbf24';
                    summaryRow.style.fontWeight = 'bold';
                    summaryRow.innerHTML = `
                        <td>YEAR 1 TOTAL</td>
                        <td>-</td>
                        <td>${formatCurrency(year1Revenue)}</td>
                        <td>${formatCurrency(year1Costs)}</td>
                        <td class="${year1Profit >= 0 ? 'text-green' : 'text-red'}">
                            ${formatCurrency(year1Profit)}
                        </td>
                        <td>-</td>
                        <td>-</td>
                    `;

                    const separatorRow = tbody.insertRow();
                    separatorRow.innerHTML = `
                        <td colspan="7" style="background: linear-gradient(to right, #3b82f6, #8b5cf6); color: white; text-align: center; font-weight: bold; padding: 10px;">
                            ═══════ YEAR 2 ═══════
                        </td>
                    `;
                }

                // Year 2 Summary
                if (index === 24) {
                    const year2SummaryRow = tbody.insertRow();
                    year2SummaryRow.style.background = '#fbbf24';
                    year2SummaryRow.style.fontWeight = 'bold';
                    year2SummaryRow.innerHTML = `
                        <td>YEAR 2 TOTAL</td>
                        <td>-</td>
                        <td>${formatCurrency(year2Revenue)}</td>
                        <td>${formatCurrency(year2Costs)}</td>
                        <td class="${year2Profit >= 0 ? 'text-green' : 'text-red'}">
                            ${formatCurrency(year2Profit)}
                        </td>
                        <td>-</td>
                        <td>-</td>
                    `;

                    const separatorRow = tbody.insertRow();
                    separatorRow.innerHTML = `
                        <td colspan="7" style="background: linear-gradient(to right, #9333ea, #7c3aed); color: white; text-align: center; font-weight: bold; padding: 10px;">
                            ═══════ YEAR 3 ═══════
                        </td>
                    `;
                }

                const row = tbody.insertRow();
                const isYear2 = index >= 12 && index < 24;
                const isYear3 = index >= 24;

                if (isYear3) {
                    row.style.background = index % 2 === 0 ? '#f3e8ff' : '#e9d5ff';
                } else if (isYear2) {
                    row.style.background = index % 2 === 0 ? '#f0f9ff' : '#e0f2fe';
                } else {
                    row.style.background = index % 2 === 0 ? '#f9fafb' : '#f3f4f6';
                }

                row.innerHTML = `
                    <td style="font-weight: ${index === 11 || index === 23 || index === 35 ? 'bold' : 'normal'}">
                        Month ${proj.month} ${index === 11 ? '(Y1 End)' : index === 23 ? '(Y2 End)' : index === 35 ? '(Y3 End)' : ''}
                    </td>
                    <td>${proj.users.toLocaleString()}</td>
                    <td>${formatCurrency(proj.revenue)}</td>
                    <td>${formatCurrency(proj.costs)}</td>
                    <td class="${proj.profit >= 0 ? 'text-green' : 'text-red'}">
                        ${formatCurrency(proj.profit)}
                    </td>
                    <td>${formatCurrency(proj.cashPosition)}</td>
                    <td>${formatCurrency(proj.arpu)}</td>
                `;
            });

            // Year 3 Summary
            const year3SummaryRow = tbody.insertRow();
            year3SummaryRow.style.background = '#fbbf24';
            year3SummaryRow.style.fontWeight = 'bold';
            year3SummaryRow.innerHTML = `
                <td>YEAR 3 TOTAL</td>
                <td>-</td>
                <td>${formatCurrency(year3Revenue)}</td>
                <td>${formatCurrency(year3Costs)}</td>
                <td class="${year3Profit >= 0 ? 'text-green' : 'text-red'}">
                    ${formatCurrency(year3Profit)}
                </td>
                <td>-</td>
                <td>-</td>
            `;

            // Grand Total
            const grandTotalRow = tbody.insertRow();
            grandTotalRow.style.background = 'linear-gradient(to right, #10b981, #059669)';
            grandTotalRow.style.color = 'white';
            grandTotalRow.style.fontWeight = 'bold';
            const totalRevenue = year1Revenue + year2Revenue + year3Revenue;
            const totalCosts = year1Costs + year2Costs + year3Costs;
            const totalProfit = year1Profit + year2Profit + year3Profit;
            grandTotalRow.innerHTML = `
                <td>3-YEAR TOTAL</td>
                <td>${lastMonth.users.toLocaleString()} users</td>
                <td>${formatCurrency(totalRevenue)}</td>
                <td>${formatCurrency(totalCosts)}</td>
                <td>${formatCurrency(totalProfit)}</td>
                <td>${formatCurrency(lastMonth.cashPosition)}</td>
                <td>-</td>
            `;
            } catch (error) {
                console.error('Error updating table:', error);
            }
        }
        
        function updateUI(data) {
            const {projections, lastMonth, year1Month, totalBurn, firstProfitableMonth, variableCostPerUser} = data;

            updateLoanDisplays(lastMonth.users);
            updateFixedCostDisplays(lastMonth.users);
            
            document.getElementById('year1Users').textContent = year1Month.users.toLocaleString();
            document.getElementById('year2Users').textContent = lastMonth.users.toLocaleString();
            document.getElementById('finalRevenue').textContent = formatCurrency(lastMonth.revenue);
            document.getElementById('arpu').textContent = formatCurrency(lastMonth.arpu);
            document.getElementById('year1Profit').textContent = formatCurrency(year1Month.profit);
            
            const profitElement = document.getElementById('finalProfit');
            profitElement.textContent = formatCurrency(lastMonth.profit);
            profitElement.className = 'metric-value ' + (lastMonth.profit >= 0 ? 'text-green' : 'text-red');
            
            document.getElementById('cashPosition').textContent = formatCurrency(lastMonth.cashPosition);
            
            const currentBurnRate = lastMonth.profit < 0 ? Math.abs(lastMonth.profit) : 0;
            const runway = currentBurnRate > 0 ? Math.round(lastMonth.cashPosition / currentBurnRate) : Infinity;
            document.getElementById('runway').textContent = runway === Infinity ? '∞' : runway + ' months';
            
            document.getElementById('profitableMonth').textContent = 
                firstProfitableMonth ? 'Month ' + firstProfitableMonth : 'Beyond 24 months';
            document.getElementById('totalBurn').textContent = formatCurrency(Math.round(totalBurn));
            document.getElementById('unitEconomics').textContent = formatCurrency(variableCostPerUser);
            document.getElementById('finalUsersCount').textContent = lastMonth.users.toLocaleString();
            
            // Update break-even analysis
            updateBreakEvenAnalysis(data);
            
            // Calculate yearly summaries
            let year1Revenue = 0, year1Costs = 0, year1Profit = 0;
            let year2Revenue = 0, year2Costs = 0, year2Profit = 0;
            
            projections.forEach((proj, index) => {
                if (index < 12) {
                    year1Revenue += proj.revenue;
                    year1Costs += proj.costs;
                    year1Profit += proj.profit;
                } else {
                    year2Revenue += proj.revenue;
                    year2Costs += proj.costs;
                    year2Profit += proj.profit;
                }
            });
            
            // Use optimized table update
            updateTableIfChanged(projections, year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit, lastMonth);

            // Update 3-year summary
            update3YearSummary(projections);

            // Update step summary for conclusion
            updateStepSummary();

            // Update final P&L view
            updateFinalPLView(projections);
        }

        // New function to update 3-year financial summary
        function update3YearSummary(projections) {
            // Calculate yearly totals
            let year1Revenue = 0, year1Costs = 0, year1Profit = 0;
            let year2Revenue = 0, year2Costs = 0, year2Profit = 0;
            let year3Revenue = 0, year3Costs = 0, year3Profit = 0;

            projections.forEach((proj, index) => {
                if (index < 12) {
                    year1Revenue += proj.revenue;
                    year1Costs += proj.costs;
                    year1Profit += proj.profit;
                } else if (index < 24) {
                    year2Revenue += proj.revenue;
                    year2Costs += proj.costs;
                    year2Profit += proj.profit;
                } else {
                    year3Revenue += proj.revenue;
                    year3Costs += proj.costs;
                    year3Profit += proj.profit;
                }
            });

            const year1Users = projections[11].users;
            const year2Users = projections[23].users;
            const year3Users = projections[35].users;

            const total3YearRevenue = year1Revenue + year2Revenue + year3Revenue;
            const total3YearProfit = year1Profit + year2Profit + year3Profit;

            // Update executive summary cards
            document.getElementById('total3YearRevenue').textContent = formatCurrency(total3YearRevenue);
            document.getElementById('final3YearUsers').textContent = year3Users.toLocaleString();
            document.getElementById('total3YearProfit').textContent = formatCurrency(total3YearProfit);
            document.getElementById('final3YearMonthlyRevenue').textContent = formatCurrency(projections[35].revenue);

            // Update growth metrics
            const revenueGrowthY2 = year1Revenue > 0 ? ((year2Revenue - year1Revenue) / year1Revenue * 100).toFixed(0) : 0;
            const revenueGrowthY3 = year2Revenue > 0 ? ((year3Revenue - year2Revenue) / year2Revenue * 100).toFixed(0) : 0;
            const userGrowthY2 = ((year2Users - year1Users) / year1Users * 100).toFixed(0);
            const userGrowthY3 = ((year3Users - year2Users) / year2Users * 100).toFixed(0);

            const profitMarginY1 = year1Revenue > 0 ? (year1Profit / year1Revenue * 100).toFixed(0) : 0;
            const profitMarginY3 = year3Revenue > 0 ? (year3Profit / year3Revenue * 100).toFixed(0) : 0;

            document.getElementById('revenueGrowthY2').textContent = `+${revenueGrowthY2}%`;
            document.getElementById('revenueGrowthY3').textContent = `+${revenueGrowthY3}%`;
            document.getElementById('userGrowthY2').textContent = `+${userGrowthY2}%`;
            document.getElementById('userGrowthY3').textContent = `+${userGrowthY3}%`;
            document.getElementById('profitMarginY1').textContent = `${profitMarginY1}%`;
            document.getElementById('profitMarginY3').textContent = `${profitMarginY3}%`;

            // Update P&L Statement
            updatePLStatement(year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit, year3Revenue, year3Costs, year3Profit, projections);

            // Update transaction grid
            updateTransactionGrid(year1Users, year2Users, year3Users, projections);
        }

        // Function to update P&L Statement table
        function updatePLStatement(y1Rev, y1Costs, y1Profit, y2Rev, y2Costs, y2Profit, y3Rev, y3Costs, y3Profit, projections) {
            const tbody = document.getElementById('plStatementTable');
            if (!tbody) return;

            // Calculate detailed breakdown
            const variableCostPerUser = parseFloat(document.getElementById('totalVariableCost').value) || 0.558;

            const y1VariableCosts = projections.slice(0, 12).reduce((sum, proj) => sum + (proj.users * variableCostPerUser), 0);
            const y2VariableCosts = projections.slice(12, 24).reduce((sum, proj) => sum + (proj.users * variableCostPerUser), 0);
            const y3VariableCosts = projections.slice(24, 36).reduce((sum, proj) => sum + (proj.users * variableCostPerUser), 0);

            const y1FixedCosts = y1Costs - y1VariableCosts;
            const y2FixedCosts = y2Costs - y2VariableCosts;
            const y3FixedCosts = y3Costs - y3VariableCosts;

            const y1GrossProfit = y1Rev - y1VariableCosts;
            const y2GrossProfit = y2Rev - y2VariableCosts;
            const y3GrossProfit = y3Rev - y3VariableCosts;

            const y1GrossMargin = y1Rev > 0 ? (y1GrossProfit / y1Rev * 100).toFixed(1) : 0;
            const y2GrossMargin = y2Rev > 0 ? (y2GrossProfit / y2Rev * 100).toFixed(1) : 0;
            const y3GrossMargin = y3Rev > 0 ? (y3GrossProfit / y3Rev * 100).toFixed(1) : 0;

            tbody.innerHTML = `
                <tr style="background: #f0fdf4;">
                    <td style="padding: 12px; font-weight: 600; color: #15803d;">💰 Total Revenue</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #15803d;">${formatCurrency(y1Rev)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #15803d;">${formatCurrency(y2Rev)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #15803d;">${formatCurrency(y3Rev)}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 12px;">Money from subscriptions + loans</td>
                </tr>
                <tr>
                    <td style="padding: 12px; color: #dc2626; padding-left: 24px;">📱 Variable Costs (COGS)</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${formatCurrency(y1VariableCosts)}</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${formatCurrency(y2VariableCosts)}</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${formatCurrency(y3VariableCosts)}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 12px;">API costs that grow with users</td>
                </tr>
                <tr style="background: #eff6ff; border-top: 1px solid #e5e7eb;">
                    <td style="padding: 12px; font-weight: 600; color: #1d4ed8;">📊 Gross Profit</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #1d4ed8;">${formatCurrency(y1GrossProfit)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #1d4ed8;">${formatCurrency(y2GrossProfit)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #1d4ed8;">${formatCurrency(y3GrossProfit)}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 12px;">Revenue minus direct costs</td>
                </tr>
                <tr style="background: #eff6ff;">
                    <td style="padding: 12px; color: #6b7280; padding-left: 24px; font-style: italic;">Gross Margin %</td>
                    <td style="padding: 12px; text-align: right; color: #6b7280; font-style: italic;">${y1GrossMargin}%</td>
                    <td style="padding: 12px; text-align: right; color: #6b7280; font-style: italic;">${y2GrossMargin}%</td>
                    <td style="padding: 12px; text-align: right; color: #6b7280; font-style: italic;">${y3GrossMargin}%</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 12px;">% of revenue after direct costs</td>
                </tr>
                <tr>
                    <td style="padding: 12px; color: #dc2626; padding-left: 24px;">🏢 Operating Expenses</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${formatCurrency(y1FixedCosts)}</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${formatCurrency(y2FixedCosts)}</td>
                    <td style="padding: 12px; text-align: right; color: #dc2626;">${formatCurrency(y3FixedCosts)}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 12px;">Salaries, marketing, office, etc.</td>
                </tr>
                <tr style="background: #fef3c7; border-top: 2px solid #f59e0b;">
                    <td style="padding: 12px; font-weight: bold; color: #92400e;">🎯 Net Income (Profit/Loss)</td>
                    <td style="padding: 12px; text-align: right; font-weight: bold; color: ${y1Profit >= 0 ? '#15803d' : '#dc2626'};">${formatCurrency(y1Profit)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: bold; color: ${y2Profit >= 0 ? '#15803d' : '#dc2626'};">${formatCurrency(y2Profit)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: bold; color: ${y3Profit >= 0 ? '#15803d' : '#dc2626'};">${formatCurrency(y3Profit)}</td>
                    <td style="padding: 12px; color: #6b7280; font-size: 12px;">Final profit after all expenses</td>
                </tr>
            `;
        }

        // Function to update transaction grid
        function updateTransactionGrid(y1Users, y2Users, y3Users, projections) {
            const grid = document.getElementById('transactionGrid');
            if (!grid) return;

            // Calculate transaction metrics
            const premiumConversion = parseFloat(document.getElementById('premiumConversion').value) || 20;
            const premiumPrice = parseFloat(document.getElementById('premiumPrice').value) || 3.00;

            const y1PremiumUsers = Math.round(y1Users * (premiumConversion / 100));
            const y2PremiumUsers = Math.round(y2Users * (premiumConversion / 100));
            const y3PremiumUsers = Math.round(y3Users * (premiumConversion / 100));

            const y1PremiumRevenue = y1PremiumUsers * premiumPrice * 12;
            const y2PremiumRevenue = y2PremiumUsers * premiumPrice * 12;
            const y3PremiumRevenue = y3PremiumUsers * premiumPrice * 12;

            // Calculate loan transactions
            const loanSize1 = parseFloat(document.getElementById('loanSize1').value) || 2000;
            const commission1 = parseFloat(document.getElementById('commission1').value) || 0.5;
            const userReach1 = parseFloat(document.getElementById('userReach1').value) || 20;
            const successRate1 = parseFloat(document.getElementById('successRate1').value) || 15;

            const y1Loans = Math.round(y1Users * (userReach1/100) * (successRate1/100) * 0.1 * 12);
            const y2Loans = Math.round(y2Users * (userReach1/100) * (successRate1/100) * 0.1 * 12);
            const y3Loans = Math.round(y3Users * (userReach1/100) * (successRate1/100) * 0.1 * 12);

            const loanCommission = loanSize1 * (commission1 / 100);

            grid.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="color: #15803d; font-weight: 600; font-size: 14px; margin-bottom: 8px;">💳 Premium Subscribers</div>
                    <div style="font-size: 20px; font-weight: bold; color: #166534; margin-bottom: 4px;">Y3: ${y3PremiumUsers.toLocaleString()}</div>
                    <div style="font-size: 12px; color: #16a34a;">Annual Revenue: ${formatCurrency(y3PremiumRevenue)}</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Y1: ${y1PremiumUsers.toLocaleString()} | Y2: ${y2PremiumUsers.toLocaleString()}</div>
                </div>
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="color: #1d4ed8; font-weight: 600; font-size: 14px; margin-bottom: 8px;">🏦 Loan Transactions</div>
                    <div style="font-size: 20px; font-weight: bold; color: #1e40af; margin-bottom: 4px;">Y3: ${y3Loans}</div>
                    <div style="font-size: 12px; color: #2563eb;">Avg Commission: ${formatCurrency(loanCommission)}</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Y1: ${y1Loans} | Y2: ${y2Loans}</div>
                </div>
                <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="color: #b45309; font-weight: 600; font-size: 14px; margin-bottom: 8px;">📊 Monthly Active Users</div>
                    <div style="font-size: 20px; font-weight: bold; color: #92400e; margin-bottom: 4px;">${y3Users.toLocaleString()}</div>
                    <div style="font-size: 12px; color: #d97706;">Total by Year 3</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Y1: ${y1Users.toLocaleString()} | Y2: ${y2Users.toLocaleString()}</div>
                </div>
                <div style="background: #f3e8ff; border: 1px solid #d8b4fe; border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="color: #7c3aed; font-weight: 600; font-size: 14px; margin-bottom: 8px;">💵 Revenue Per User</div>
                    <div style="font-size: 20px; font-weight: bold; color: #6b21a8; margin-bottom: 4px;">${formatCurrency(projections[35].arpu)}</div>
                    <div style="font-size: 12px; color: #8b5cf6;">Monthly ARPU (Year 3)</div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Y1: ${formatCurrency(projections[11].arpu)} | Y2: ${formatCurrency(projections[23].arpu)}</div>
                </div>
            `;
        }
        
        // Step navigation functions
        let currentStep = 1;
        const totalSteps = 5;

        function goToStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) step.style.display = 'none';
            }

            // Show target step
            const targetStep = document.getElementById(`step${stepNumber}`);
            if (targetStep) {
                targetStep.style.display = 'block';
                currentStep = stepNumber;

                // Update progress
                updateProgress();

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Update model when moving between steps
                if (stepNumber >= 4) {
                    // Force sync all step inputs before calculating results
                    syncAllStepInputs();
                    // Force immediate update for result steps
                    updateModel();
                }
                setTimeout(() => {
                    updateModel();
                }, 100);
            }
        }

        function updateProgress() {
            const progressPercent = (currentStep / totalSteps) * 100;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            if (progressFill) progressFill.style.width = `${progressPercent}%`;
            if (progressText) progressText.textContent = `Step ${currentStep} of ${totalSteps}`;
        }

        function selectGrowth(scenario) {
            // Remove active class from all cards
            document.querySelectorAll('.simple-card[data-scenario]').forEach(card => {
                card.classList.remove('active');
            });

            // Add active class to selected card
            const selectedCard = document.querySelector(`[data-scenario="${scenario}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }

            // Update the scenario and trigger calculations
            setScenario(scenario);

            // Force update the model immediately
            updateModel();
        }

        function showDetailedView() {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) step.style.display = 'none';
            }

            // Hide progress bar
            const progressContainer = document.querySelector('.progress-bar').parentElement;
            if (progressContainer) progressContainer.style.display = 'none';

            // Show final P&L view
            const finalView = document.getElementById('finalPLView');
            if (finalView) {
                finalView.style.display = 'block';
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update model
            setTimeout(() => {
                updateModel();
            }, 100);
        }

        function updateStepSummary() {
            try {
                // Update conclusion step summary values - READ FROM STEP INPUT FIRST
                const initialFundingStep = document.getElementById('initialFundingStep')?.value;
                const initialFundingHidden = document.getElementById('initialFunding')?.value;
                const initialFunding = initialFundingStep || initialFundingHidden || '500000';

                console.log('Step funding:', initialFundingStep, 'Hidden funding:', initialFundingHidden, 'Using:', initialFunding);
                const totalRevenue = document.getElementById('total3YearRevenue')?.textContent || '$0';
                const totalProfit = document.getElementById('total3YearProfit')?.textContent || '$0';
                const finalUsers = document.getElementById('final3YearUsers')?.textContent || '0';
                const profitableMonth = document.getElementById('profitableMonth')?.textContent || 'Month 8';

                // Update summary in step 5
                const startingCash = document.getElementById('startingCash');
                const totalRevenue3Y = document.getElementById('totalRevenue3Y');
                const totalProfit3Y = document.getElementById('totalProfit3Y');
                const finalUsers3Y = document.getElementById('finalUsers3Y');
                const breakEvenTime = document.getElementById('breakEvenTime');

                if (startingCash) startingCash.textContent = formatCurrency(parseFloat(initialFunding));
                if (totalRevenue3Y) totalRevenue3Y.textContent = totalRevenue;
                if (totalProfit3Y) totalProfit3Y.textContent = totalProfit;
                if (finalUsers3Y) finalUsers3Y.textContent = finalUsers;
                if (breakEvenTime) breakEvenTime.textContent = profitableMonth;

                // Also update the step 4 metrics
                const arpuElement = document.getElementById('arpu');
                const runwayElement = document.getElementById('runway');

                if (cachedProjections && cachedProjections.projections && cachedProjections.projections.length > 0) {
                    const lastMonth = cachedProjections.projections[cachedProjections.projections.length - 1];
                    if (arpuElement) arpuElement.textContent = formatCurrency(lastMonth.arpu);

                    if (runwayElement) {
                        const runway = cachedProjections.totalBurn ?
                            Math.floor(parseFloat(initialFunding) / cachedProjections.totalBurn) :
                            '24+';
                        runwayElement.textContent = runway + ' months';
                    }
                }
            } catch (error) {
                console.error('Error updating step summary:', error);
            }
        }

        // Function to update final P&L view
        function updateFinalPLView(projections) {
            // Update final view summary cards
            const totalRevenue = document.getElementById('total3YearRevenue').textContent;
            const totalProfit = document.getElementById('total3YearProfit').textContent;
            const finalUsers = document.getElementById('final3YearUsers').textContent;
            const finalMonthlyRevenue = document.getElementById('final3YearMonthlyRevenue').textContent;

            const finalCards = {
                'total3YearRevenueFinal': totalRevenue,
                'total3YearProfitFinal': totalProfit,
                'final3YearUsersFinal': finalUsers,
                'final3YearMonthlyRevenueFinal': finalMonthlyRevenue
            };

            Object.entries(finalCards).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            // Update detailed P&L table
            updateFinalPLTable(projections);
        }

        // Function to update final P&L table with detailed breakdown
        function updateFinalPLTable(projections) {
            const tbody = document.getElementById('finalPLTableBody');
            if (!tbody) return;

            const variableCostPerUser = parseFloat(document.getElementById('totalVariableCost').value) || 0.558;
            let html = '';

            projections.forEach((proj, index) => {
                const variableCosts = proj.users * variableCostPerUser;
                const fixedCosts = proj.costs - variableCosts;
                const grossProfit = proj.revenue - variableCosts;

                // Determine row styling
                let rowClass = '';
                let isYearEnd = false;

                if (index === 11 || index === 23 || index === 35) {
                    isYearEnd = true;
                    rowClass = 'font-weight: bold; background: #fef3c7;';
                } else if (index >= 24) {
                    rowClass = 'background: #f3e8ff;';
                } else if (index >= 12) {
                    rowClass = 'background: #f0f9ff;';
                } else {
                    rowClass = 'background: #f9fafb;';
                }

                html += `
                    <tr style="${rowClass}">
                        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb; ${isYearEnd ? 'font-weight: bold;' : ''}">
                            Month ${proj.month} ${index === 11 ? '(Y1 End)' : index === 23 ? '(Y2 End)' : index === 35 ? '(Y3 End)' : ''}
                        </td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${proj.users.toLocaleString()}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${formatCurrency(proj.revenue)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${formatCurrency(variableCosts)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${formatCurrency(fixedCosts)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${formatCurrency(proj.costs)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${grossProfit >= 0 ? '#059669' : '#dc2626'};">${formatCurrency(grossProfit)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb; color: ${proj.profit >= 0 ? '#059669' : '#dc2626'}; ${isYearEnd ? 'font-weight: bold;' : ''}">${formatCurrency(proj.profit)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${formatCurrency(proj.cashPosition)}</td>
                        <td style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">${formatCurrency(proj.arpu)}</td>
                    </tr>
                `;

                // Add year summary rows
                if (index === 11) {
                    html += `
                        <tr style="background: linear-gradient(to right, #3b82f6, #8b5cf6); color: white;">
                            <td colspan="10" style="padding: 12px; text-align: center; font-weight: bold; border-bottom: 2px solid #e5e7eb;">
                                ═══════ YEAR 2 BEGINS ═══════
                            </td>
                        </tr>
                    `;
                } else if (index === 23) {
                    html += `
                        <tr style="background: linear-gradient(to right, #9333ea, #7c3aed); color: white;">
                            <td colspan="10" style="padding: 12px; text-align: center; font-weight: bold; border-bottom: 2px solid #e5e7eb;">
                                ═══════ YEAR 3 BEGINS ═══════
                            </td>
                        </tr>
                    `;
                }
            });

            tbody.innerHTML = html;
        }

        // Function to go back to steps
        function goBackToSteps() {
            // Hide final view
            const finalView = document.getElementById('finalPLView');
            if (finalView) finalView.style.display = 'none';

            // Show progress bar
            const progressContainer = document.querySelector('.progress-bar').parentElement;
            if (progressContainer) progressContainer.style.display = 'block';

            // Go to step 5
            goToStep(5);
        }

        // Excel download functionality
        function downloadExcel() {
            try {
                // Get current projections data
                const projections = cachedProjections?.projections || [];
                if (projections.length === 0) {
                    alert('No data available for download. Please wait for calculations to complete.');
                    return;
                }

                // Create workbook data
                const workbookData = createExcelData(projections);

                // Convert to CSV format (simple Excel alternative)
                const csvContent = convertToCSV(workbookData);

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                const filename = `Nota_Financial_Plan_${new Date().toISOString().split('T')[0]}.csv`;

                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Your browser does not support automatic downloads. Please update your browser.');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('There was an error generating the download. Please try again.');
            }
        }

        // Function to create structured Excel data
        function createExcelData(projections) {
            const data = [];
            const variableCostPerUser = parseFloat(document.getElementById('totalVariableCost').value) || 0.558;

            // Header information
            data.push(['NOTA FINANCIAL PLAN - 3 YEAR PROJECTION']);
            data.push(['Generated on:', new Date().toLocaleDateString()]);
            data.push(['']);

            // Business assumptions
            data.push(['BUSINESS ASSUMPTIONS']);
            data.push(['Initial Funding:', formatCurrency(parseFloat(document.getElementById('initialFunding').value))]);
            data.push(['Growth Rate:', document.getElementById('currentGrowthRate').textContent + '%/month']);
            data.push(['Premium Price:', formatCurrency(parseFloat(document.getElementById('premiumPrice').value))]);
            data.push(['Premium Conversion:', document.getElementById('premiumConversion').value + '%']);
            data.push(['Variable Cost per User:', formatCurrency(variableCostPerUser)]);
            data.push(['']);

            // Summary metrics
            data.push(['SUMMARY METRICS']);
            data.push(['Total 3-Year Revenue:', document.getElementById('total3YearRevenue').textContent]);
            data.push(['Total 3-Year Profit:', document.getElementById('total3YearProfit').textContent]);
            data.push(['Final User Base:', document.getElementById('final3YearUsers').textContent]);
            data.push(['Break-even Month:', document.getElementById('profitableMonth').textContent]);
            data.push(['']);

            // Monthly breakdown header
            data.push(['MONTHLY P&L BREAKDOWN']);
            data.push(['Month', 'Users', 'Revenue', 'Variable Costs', 'Fixed Costs', 'Total Costs', 'Gross Profit', 'Net Profit', 'Cash Position', 'ARPU']);

            // Monthly data
            projections.forEach((proj, index) => {
                const variableCosts = proj.users * variableCostPerUser;
                const fixedCosts = proj.costs - variableCosts;
                const grossProfit = proj.revenue - variableCosts;

                data.push([
                    `Month ${proj.month}${index === 11 ? ' (Y1 End)' : index === 23 ? ' (Y2 End)' : index === 35 ? ' (Y3 End)' : ''}`,
                    proj.users,
                    proj.revenue,
                    variableCosts,
                    fixedCosts,
                    proj.costs,
                    grossProfit,
                    proj.profit,
                    proj.cashPosition,
                    proj.arpu
                ]);

                // Add year separators
                if (index === 11) {
                    data.push(['=== YEAR 2 BEGINS ===']);
                } else if (index === 23) {
                    data.push(['=== YEAR 3 BEGINS ===']);
                }
            });

            return data;
        }

        // Function to convert data to CSV
        function convertToCSV(data) {
            return data.map(row => {
                return row.map(cell => {
                    // Handle numbers and currency
                    if (typeof cell === 'number') {
                        return cell;
                    }
                    // Escape quotes and wrap in quotes if contains comma
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',');
            }).join('\n');
        }

        // Force sync all step inputs to hidden inputs
        function syncAllStepInputs() {
            console.log('Syncing all step inputs...');

            // Sync funding
            const fundingStep = document.getElementById('initialFundingStep')?.value;
            if (fundingStep) {
                document.getElementById('initialFunding').value = fundingStep;
                console.log('Synced funding:', fundingStep);
            }

            // Sync salaries
            const salariesStep = document.getElementById('salariesStep')?.value;
            if (salariesStep) {
                document.getElementById('salaries').value = salariesStep;
                console.log('Synced salaries:', salariesStep);
            }

            // Sync marketing
            const marketingStep = document.getElementById('marketingStep')?.value;
            if (marketingStep) {
                document.getElementById('marketing').value = marketingStep;
                console.log('Synced marketing:', marketingStep);
            }

            // Sync other costs
            const otherStep = document.getElementById('otherStep')?.value;
            if (otherStep) {
                document.getElementById('other').value = otherStep;
                console.log('Synced other costs:', otherStep);
            }

            // Sync premium price
            const premiumPriceStep = document.getElementById('premiumPriceStep')?.value;
            if (premiumPriceStep) {
                document.getElementById('premiumPrice').value = premiumPriceStep;
                console.log('Synced premium price:', premiumPriceStep);
            }

            // Sync premium conversion
            const premiumConversionStep = document.getElementById('premiumConversionStep')?.value;
            if (premiumConversionStep) {
                document.getElementById('premiumConversion').value = premiumConversionStep;
                console.log('Synced premium conversion:', premiumConversionStep);
            }

            // Sync loan size and commission
            const loanSize1Step = document.getElementById('loanSize1Step')?.value;
            if (loanSize1Step) {
                document.getElementById('loanSize1').value = loanSize1Step;
                console.log('Synced loan size 1:', loanSize1Step);
            }

            const commission1Step = document.getElementById('commission1Step')?.value;
            if (commission1Step) {
                document.getElementById('commission1').value = commission1Step;
                console.log('Synced commission 1:', commission1Step);
            }
        }

        // Functions to connect step inputs to calculation inputs
        function updateFunding() {
            const value = document.getElementById('initialFundingStep').value;
            console.log('updateFunding called with value:', value);
            document.getElementById('initialFunding').value = value;
            // Force immediate update of the display
            updateStepSummary();
            debouncedUpdate();
        }

        function updateSalaries() {
            const value = document.getElementById('salariesStep').value;
            document.getElementById('salaries').value = value;
            document.getElementById('salariesCurrent').textContent = value;
            debouncedUpdate();
        }

        function updateMarketing() {
            const value = document.getElementById('marketingStep').value;
            document.getElementById('marketing').value = value;
            document.getElementById('marketingCurrent').textContent = value;
            debouncedUpdate();
        }

        function updateOther() {
            const value = document.getElementById('otherStep').value;
            document.getElementById('other').value = value;
            document.getElementById('otherCurrent').textContent = value;
            debouncedUpdate();
        }

        function updatePremiumPrice() {
            const value = document.getElementById('premiumPriceStep').value;
            document.getElementById('premiumPrice').value = value;
            debouncedUpdate();
        }

        function updatePremiumConversion() {
            const value = document.getElementById('premiumConversionStep').value;
            document.getElementById('premiumConversion').value = value;
            debouncedUpdate();
        }

        function updateLoanSize1() {
            const value = document.getElementById('loanSize1Step').value;
            document.getElementById('loanSize1').value = value;
            updateLoanDisplays();
            debouncedUpdate();
        }

        function updateCommission1() {
            const value = document.getElementById('commission1Step').value;
            document.getElementById('commission1').value = value;
            updateLoanDisplays();
            debouncedUpdate();
        }

        function updateLoanDisplays() {
            const loanSize1 = parseFloat(document.getElementById('loanSize1').value) || 2000;
            const commission1 = parseFloat(document.getElementById('commission1').value) || 0.5;
            const commissionPerLoan1 = loanSize1 * (commission1 / 100);
            document.getElementById('commissionPerLoan1').textContent = commissionPerLoan1.toFixed(0);
        }

        // Sync step inputs with hidden inputs on load
        function syncStepInputs() {
            // Sync from hidden to step inputs
            document.getElementById('initialFundingStep').value = document.getElementById('initialFunding').value;
            document.getElementById('salariesStep').value = document.getElementById('salaries').value;
            document.getElementById('marketingStep').value = document.getElementById('marketing').value;
            document.getElementById('otherStep').value = document.getElementById('other').value;
            document.getElementById('premiumPriceStep').value = document.getElementById('premiumPrice').value;
            document.getElementById('premiumConversionStep').value = document.getElementById('premiumConversion').value;
            document.getElementById('loanSize1Step').value = document.getElementById('loanSize1').value;
            document.getElementById('commission1Step').value = document.getElementById('commission1').value;

            updateLoanDisplays();
        }

        // Initialize on load (non-blocking)
        setTimeout(() => {
            syncStepInputs();
            updateModel();
            updateProgress(); // Set initial progress
        }, 10);
        
        // Fetch exchange rates in background (non-blocking)
        setTimeout(() => {
            fetchExchangeRates();
        }, 500);
        
        // Failsafe to ensure cursor is reset after all initialization
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.body.style.cursor = 'default';
            }, 1000);
        });
    </script>
</body>
</html>
