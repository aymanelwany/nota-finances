<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nota Financial Model Calculator - 2 Year Projection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: #111;
        }
        
        .header p {
            color: #666;
        }
        
        .cost-per-user-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .metric-sub {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .config-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .subsection-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .scenario-btn {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scenario-btn:hover {
            border-color: #3b82f6;
        }
        
        .scenario-btn.active {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #1d4ed8;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            color: #555;
        }
        
        .input-group input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .revenue-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .revenue-card h4 {
            margin-bottom: 12px;
        }
        
        .revenue-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .loan-model-card {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .loan-model-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }
        
        td {
            padding: 8px 12px;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:nth-child(even) {
            background: #f9fafb;
        }
        
        .summary-section {
            background: linear-gradient(to right, #2563eb, #9333ea);
            padding: 24px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .summary-item p:first-child {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .summary-item p:last-child {
            font-size: 24px;
            font-weight: bold;
        }
        
        .text-green { color: #16a34a; }
        .text-red { color: #dc2626; }
        .text-blue { color: #2563eb; }
        .text-purple { color: #9333ea; }
        
        /* Info Modal Styles */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 6px;
            user-select: none;
        }
        
        .info-icon:hover {
            background: #2563eb;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .formula-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            text-align: center;
        }
        
        .example-box {
            background: #ecfdf5;
            border: 1px solid #d1fae5;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .header {
                padding: 16px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 20px;
                margin-bottom: 6px;
            }
            
            .header p {
                font-size: 13px;
            }
            
            /* Header currency selector responsive */
            .header > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px !important;
            }
            
            .cost-per-user-card {
                padding: 16px;
                margin-bottom: 15px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .metric-card {
                padding: 12px;
            }
            
            .metric-value {
                font-size: 20px;
            }
            
            .config-section {
                padding: 16px;
                margin-bottom: 15px;
            }
            
            .section-title {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .subsection-title {
                font-size: 15px;
                margin-bottom: 10px;
            }
            
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .scenario-btn {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            .cost-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .revenue-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .loan-model-inputs {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            /* Break-even analysis mobile */
            .break-even-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Sensitivity analysis mobile */
            .sensitivity-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Table responsive */
            .table-container {
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            table {
                font-size: 12px;
                min-width: 700px; /* Ensure table doesn't get too compressed */
            }
            
            th, td {
                padding: 6px 4px !important;
                white-space: nowrap;
            }
            
            /* Sticky header for mobile tables */
            thead th {
                position: sticky;
                top: 0;
                background: #f9fafb;
                z-index: 10;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .summary-item {
                padding: 12px;
            }
            
            .summary-item p:first-child {
                font-size: 12px;
            }
            
            .summary-item p:last-child {
                font-size: 16px;
            }
            
            /* Modal responsive */
            .modal-content {
                margin: 10px;
                padding: 20px;
                max-height: 85vh;
            }
            
            .modal-title {
                font-size: 16px;
            }
            
            /* Input improvements for touch */
            input[type="number"], input[type="range"], select {
                min-height: 44px; /* iOS recommended touch target */
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .input-group input {
                padding: 12px 8px;
            }
            
            /* Info icon touch target */
            .info-icon {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .cost-grid {
                grid-template-columns: 1fr;
            }
            
            .loan-model-inputs {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            /* Very small screens - hide some less critical info */
            .metric-sub {
                display: none;
            }
            
            /* Smaller text for tables on very small screens */
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 4px 2px !important;
            }
            
            /* Loan matching section stack vertically */
            .loan-matching-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
        }
        
        /* Touch improvements for all screen sizes */
        .scenario-btn:hover, .scenario-btn:focus {
            transform: scale(1.02);
            transition: transform 0.1s;
        }
        
        input[type="range"] {
            height: 8px;
            -webkit-appearance: none;
            background: #e5e7eb;
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        /* Collapsible sections for mobile */
        .mobile-collapsible {
            display: none;
        }
        
        .mobile-toggle {
            display: none;
            width: 100%;
            padding: 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .mobile-toggle:hover {
            background: #e5e7eb;
        }
        
        .mobile-toggle::after {
            content: " ‚ñº";
            float: right;
            transform: rotate(0deg);
            transition: transform 0.3s;
        }
        
        .mobile-toggle.active::after {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
            }
            
            .mobile-collapsible {
                display: block;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }
            
            .mobile-collapsible.active {
                max-height: 1000px;
            }
        }
        
        .cost-input-large {
            font-size: 28px;
            font-weight: bold;
            width: 120px;
            padding: 5px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h1>Nota Financial Model Calculator</h1>
                    <p>Financial Assistant for Micro SMEs - 2 Year Projections</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div>
                        <label style="font-size: 14px; color: #666; margin-bottom: 4px; display: block;">Currency</label>
                        <select id="currencySelect" onchange="changeCurrency()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; background: white;">
                            <option value="USD">üá∫üá∏ USD</option>
                            <option value="GBP">üá¨üáß GBP</option>
                            <option value="EGP">üá™üá¨ EGP</option>
                            <option value="SAR">üá∏üá¶ SAR</option>
                        </select>
                    </div>
                    <div id="exchangeRateDisplay" style="font-size: 12px; color: #666; text-align: center;">
                        <div>Exchange Rate</div>
                        <div id="rateValue">1.000</div>
                        <div id="lastUpdate" style="font-size: 10px;">Live</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cost Per User Card -->
        <div class="cost-per-user-card">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 8px; color: white;">Total Cost Per User (Monthly)</h3>
                    <p style="opacity: 0.9; font-size: 14px; color: rgba(255,255,255,0.9);">
                        Whisper ($<span id="whisperDisplay">0.450</span>) + GPT-4 ($<span id="gpt4Display">0.105</span>) + Firebase ($<span id="firebaseDisplay">0.003</span>)
                    </p>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px;">
                    <span style="font-size: 24px; color: white;">$</span>
                    <input type="number" step="0.001" id="costPerUserQuick" value="0.558" class="cost-input-large"
                           onchange="updateFromTotalCost()"
                           title="Edit total cost per user">
                    <span style="font-size: 18px; opacity: 0.9; color: white;">/user</span>
                </div>
            </div>
        </div>
        
        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Year 1 / Year 2 Users</div>
                <div class="metric-value text-blue"><span id="year1Users">50,000</span></div>
                <div class="metric-sub">Year 2: <span id="year2Users">150,000</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Monthly Revenue (End Y2)</div>
                <div class="metric-value text-green" id="finalRevenue">$99,900</div>
                <div class="metric-sub">ARPU: $<span id="arpu">2.00</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Monthly Profit (End Y2)</div>
                <div class="metric-value" id="finalProfit">$10,000</div>
                <div class="metric-sub">Year 1: $<span id="year1Profit">0</span></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Runway</div>
                <div class="metric-value text-purple" id="runway">‚àû</div>
                <div class="metric-sub">Cash: $<span id="cashPosition">500,000</span></div>
            </div>
        </div>
        
        <!-- Configuration -->
        <div class="config-section">
            <h2 class="section-title">Model Configuration</h2>
            
            <!-- Growth Scenario -->
            <div>
                <h3 class="subsection-title">Growth Scenario & Timeline</h3>
                <div class="button-grid">
                    <button class="scenario-btn" onclick="setScenario('conservative')" data-scenario="conservative">
                        <div style="font-weight: 500;">Conservative</div>
                        <div style="font-size: 14px;">15%</div>
                    </button>
                    <button class="scenario-btn active" onclick="setScenario('base')" data-scenario="base">
                        <div style="font-weight: 500;">Base</div>
                        <div style="font-size: 14px;">30%</div>
                    </button>
                    <button class="scenario-btn" onclick="setScenario('aggressive')" data-scenario="aggressive">
                        <div style="font-weight: 500;">Aggressive</div>
                        <div style="font-size: 14px;">50%</div>
                    </button>
                    <button class="scenario-btn" onclick="setScenario('custom')" data-scenario="custom">
                        <div style="font-weight: 500;">Custom</div>
                        <div style="font-size: 14px;"><span id="customRateDisplay">30</span>%</div>
                    </button>
                </div>
                <div id="customRateInput" style="display: none; margin-top: 12px;">
                    <label>Custom Growth Rate (%)</label>
                    <input type="number" id="customRate" value="30" onchange="debouncedUpdate()">
                </div>
                <div style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                    <p style="margin: 0; color: #4b5563;">
                        üìä <strong>Timeline:</strong> 24 months | 
                        <strong>Y1 Target:</strong> 50,000 users | 
                        <strong>Growth Rate:</strong> <span id="currentGrowthRate">30</span>%/month
                    </p>
                </div>
            </div>
            
            <!-- Initial Funding -->
            <div style="margin-top: 24px;">
                <h3 class="subsection-title">Initial Funding</h3>
                <div class="input-group" style="max-width: 200px;">
                    <input type="number" id="initialFunding" value="500000" onchange="debouncedUpdate()">
                </div>
            </div>
            
            <!-- Variable Costs -->
            <div style="margin-top: 24px;">
                <h3 class="subsection-title">Variable Costs (Per User/Month)</h3>
                <div class="cost-grid">
                    <div class="input-group">
                        <label>Whisper API</label>
                        <input type="number" step="0.001" id="whisperCost" value="0.45" onchange="debouncedUpdate()">
                    </div>
                    <div class="input-group">
                        <label>GPT-4 API</label>
                        <input type="number" step="0.001" id="gpt4Cost" value="0.105" onchange="debouncedUpdate()">
                    </div>
                    <div class="input-group">
                        <label>Firebase</label>
                        <input type="number" step="0.001" id="firebaseCost" value="0.003" onchange="debouncedUpdate()">
                    </div>
                    <div class="input-group">
                        <label style="font-weight: bold;">Total/User</label>
                        <input type="number" id="totalVariableCost" value="0.558" disabled style="background: #f5f5f5; font-weight: bold;">
                    </div>
                </div>
            </div>
            
            <!-- Fixed Costs -->
            <div style="margin-top: 24px;">
                <h3 class="subsection-title">Monthly Fixed Costs</h3>
                <div class="cost-grid">
                    <div class="input-group">
                        <label>Salaries</label>
                        <input type="number" id="salaries" value="2000" onchange="debouncedUpdate()">
                    </div>
                    <div class="input-group">
                        <label>Office</label>
                        <input type="number" id="office" value="0" onchange="debouncedUpdate()">
                    </div>
                    <div class="input-group">
                        <label>Marketing</label>
                        <input type="number" id="marketing" value="1000" onchange="debouncedUpdate()">
                    </div>
                    <div class="input-group">
                        <label>Other</label>
                        <input type="number" id="other" value="1000" onchange="debouncedUpdate()">
                    </div>
                </div>
            </div>
            
            <!-- Revenue Streams -->
            <div style="margin-top: 24px;">
                <h3 class="subsection-title">Revenue Streams</h3>
                
                <!-- Premium Subscriptions -->
                <div class="revenue-card">
                    <h4>Premium Subscriptions</h4>
                    <div class="revenue-inputs">
                        <div class="input-group">
                            <label>Monthly Price ($)</label>
                            <input type="number" step="0.01" id="premiumPrice" value="3.00" onchange="debouncedUpdate()">
                        </div>
                        <div class="input-group">
                            <label>Conversion Rate (%)</label>
                            <input type="number" id="premiumConversion" value="20" onchange="debouncedUpdate()">
                        </div>
                    </div>
                </div>
                
                <!-- Dual Loan Model -->
                <div class="revenue-card">
                    <h4>üí∞ Loan Matching - Dual Market Model</h4>
                    
                    <!-- Model 1 -->
                    <div style="background: #e0f2fe; padding: 12px; border-radius: 6px; margin: 10px 0; border: 2px solid #0284c7;">
                        <h5 style="color: #0369a1; margin-bottom: 10px;">Model 1: Developing Market / Microloans</h5>
                        <div class="loan-model-inputs">
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">Avg Loan ($)</label>
                                <input type="number" id="loanSize1" value="2000" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">Commission (%)</label>
                                <input type="number" step="0.1" id="commission1" value="0.5" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">User Reach (%)</label>
                                <input type="number" id="userReach1" value="20" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">Success Rate (%)</label>
                                <input type="number" id="successRate1" value="15" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px;">
                            <p style="margin: 0; font-size: 12px;">
                                Commission/loan: $<span id="commissionPerLoan1">10</span> | 
                                Loans/month: <span id="loansPerMonth1">0</span> |
                                Revenue: $<span id="loanRevenue1">0</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Model 2 -->
                    <div style="background: #dcfce7; padding: 12px; border-radius: 6px; margin: 10px 0; border: 2px solid #16a34a;">
                        <h5 style="color: #14532d; margin-bottom: 10px;">Model 2: Standard Market / SME Loans</h5>
                        <div class="loan-model-inputs">
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">Avg Loan ($)</label>
                                <input type="number" id="loanSize2" value="5000" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">Commission (%)</label>
                                <input type="number" step="0.1" id="commission2" value="0.5" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">User Reach (%)</label>
                                <input type="number" id="userReach2" value="10" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 12px;">Success Rate (%)</label>
                                <input type="number" id="successRate2" value="10" onchange="debouncedUpdate()" style="padding: 6px;">
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px;">
                            <p style="margin: 0; font-size: 12px;">
                                Commission/loan: $<span id="commissionPerLoan2">25</span> | 
                                Loans/month: <span id="loansPerMonth2">0</span> |
                                Revenue: $<span id="loanRevenue2">0</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 2px solid #f59e0b;">
                        <p style="margin: 0; font-size: 14px; font-weight: 600; color: #92400e;">
                            Total Loan Revenue: $<span id="totalLoanRevenue" style="font-size: 18px;">0</span>/month
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
<!-- Projections Table -->
        <div class="config-section">
            <h3 class="subsection-title">Monthly Projections (24 Months)</h3>
            <div class="table-container" style="overflow-x: auto; max-height: 600px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                <table>
                    <thead>
                        <tr>
                            <th>MONTH</th>
                            <th>USERS</th>
                            <th>REVENUE</th>
                            <th>COSTS</th>
                            <th>PROFIT/LOSS</th>
                            <th>CASH POSITION</th>
                            <th>ARPU</th>
                        </tr>
                    </thead>
                    <tbody id="projectionsTable">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Break-Even Analysis -->
        <div class="config-section">
            <h3 class="subsection-title">üìä Break-Even Analysis & Key Metrics</h3>
            
            <div class="break-even-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Break-Even Metrics -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 8px; color: white;">
                    <h4 style="margin-bottom: 16px; font-size: 18px;">Break-Even Analysis</h4>
                    <div style="display: grid; gap: 12px;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.9;">Break-Even Users (Monthly)</div>
                            <div style="font-size: 24px; font-weight: bold;" id="breakEvenUsers">12,500</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.9;">Break-Even Revenue (Monthly)</div>
                            <div style="font-size: 18px; font-weight: bold;" id="breakEvenRevenue">$25,000</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.9;">Months to Break-Even</div>
                            <div style="font-size: 18px; font-weight: bold;" id="monthsToBreakEven">8</div>
                        </div>
                    </div>
                </div>
                
                <!-- Unit Economics -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding: 20px; border-radius: 8px; color: white;">
                    <h4 style="margin-bottom: 16px; font-size: 18px;">Unit Economics</h4>
                    <div style="display: grid; gap: 12px;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.9;">
                                Customer Acquisition Cost
                                <span class="info-icon" onclick="showCACModal()" title="How is CAC calculated?">i</span>
                            </div>
                            <div style="font-size: 24px; font-weight: bold;" id="cac">$2.50</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.9;">LTV:CAC Ratio</div>
                            <div style="font-size: 18px; font-weight: bold;" id="ltvCacRatio">8.0x</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.9;">Payback Period (Months)</div>
                            <div style="font-size: 18px; font-weight: bold;" id="paybackPeriod">3.2</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sensitivity Sliders -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h4 style="margin-bottom: 16px; font-size: 16px; color: #1a202c;">üéöÔ∏è Sensitivity Analysis</h4>
                <div class="sensitivity-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #4a5568;">Premium Conversion Rate: <span id="sensitivityConversion">20%</span></label>
                        <input type="range" id="sensitivityConversionSlider" min="5" max="50" value="20" step="1" 
                               onchange="updateSensitivity()" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #4a5568;">Monthly Growth Rate: <span id="sensitivityGrowth">30%</span></label>
                        <input type="range" id="sensitivityGrowthSlider" min="5" max="100" value="30" step="5" 
                               onchange="updateSensitivity()" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #4a5568;">Variable Cost/User: <span id="sensitivityCost">$0.56</span></label>
                        <input type="range" id="sensitivityCostSlider" min="0.1" max="2.0" value="0.56" step="0.01" 
                               onchange="updateSensitivity()" style="width: 100%;">
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <div style="font-size: 14px; color: #4a5568;">Impact on Break-Even:</div>
                    <div style="font-size: 18px; font-weight: bold; color: #1a202c;" id="sensitivityImpact">Break-even in 8 months with 12,500 users</div>
                </div>
            </div>
        </div>
        
<!-- Summary -->
        <div class="summary-section">
            <h3 style="font-size: 20px; margin-bottom: 16px;">Investment Summary (2 Years)</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <p>Path to Profitability</p>
                    <p id="profitableMonth">Month 6</p>
                </div>
                <div class="summary-item">
                    <p>Total Investment Needed</p>
                    <p id="totalBurn">$150,000</p>
                </div>
                <div class="summary-item">
                    <p>Unit Economics (Cost/User)</p>
                    <p id="unitEconomics">$0.558</p>
                </div>
                <div class="summary-item">
                    <p>Year 2 End Users</p>
                    <p id="finalUsersCount">100,000</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CAC Info Modal -->
    <div id="cacModal" class="modal-overlay" onclick="closeCACModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">üí∞ Customer Acquisition Cost (CAC)</h3>
                <button class="modal-close" onclick="closeCACModal()">&times;</button>
            </div>
            
            <div style="color: #4b5563; line-height: 1.6;">
                <p><strong>Customer Acquisition Cost (CAC)</strong> measures how much it costs to acquire each new paying customer.</p>
                
                <div class="formula-box">
                    <strong>CAC = Marketing Spend √∑ Number of New Users</strong>
                </div>
                
                <h4 style="margin: 20px 0 12px 0; color: #1f2937;">How it's calculated in this model:</h4>
                
                <div class="example-box">
                    <p><strong>Example Calculation:</strong></p>
                    <ul style="margin: 12px 0; padding-left: 20px;">
                        <li><span class="highlight">Marketing Budget:</span> $1,000/month</li>
                        <li><span class="highlight">Total Users:</span> 50,000 users</li>
                        <li><span class="highlight">CAC:</span> $1,000 √∑ 50,000 = $0.02 per user</li>
                    </ul>
                </div>
                
                <h4 style="margin: 20px 0 12px 0; color: #1f2937;">Key Insights:</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li><strong>Lower is better:</strong> Less cost per customer means better efficiency</li>
                    <li><strong>Compare to LTV:</strong> CAC should be much lower than Customer Lifetime Value</li>
                    <li><strong>Track over time:</strong> CAC often increases as you scale marketing</li>
                    <li><strong>Channel-specific:</strong> Different marketing channels have different CACs</li>
                </ul>
                
                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #92400e;">
                        <strong>üí° Pro Tip:</strong> A good SaaS business typically has an LTV:CAC ratio of 3:1 or higher, meaning customers generate at least 3x their acquisition cost.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentScenario = 'base';
        const growthRates = {
            conservative: 15,
            base: 30,
            aggressive: 50,
            custom: 30
        };
        
        // Performance optimizations
        let updateTimeout;
        let lastInputHash = '';
        let cachedProjections = null;
        let lastTableData = null;
        
        // Multi-currency support
        let currentCurrency = 'USD';
        let exchangeRates = { USD: 1, GBP: 0.79, EGP: 30.85, SAR: 3.75 };
        let lastRateUpdate = 0;
        
        
        
        // Debounced update function
        function debouncedUpdate() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updateModel, 300);
        }
        
        // Input validation function
        function validateInput(element, min = 0, max = Infinity) {
            let value = parseFloat(element.value);
            if (isNaN(value) || value < min) value = min;
            if (value > max) value = max;
            element.value = value;
            return value;
        }
        
        // Generate hash of all inputs for caching
        function getInputHash() {
            const inputs = document.querySelectorAll('input[type="number"]');
            return Array.from(inputs).map(i => i.value).join('|') + currentScenario;
        }
        
        // Currency conversion functions
        async function fetchExchangeRates() {
            try {
                // Using a free API for exchange rates (fallback to static rates if fails)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    // Only update rates for our supported currencies
                    const newRates = {
                        USD: 1,
                        GBP: data.rates.GBP || 0.79,
                        EGP: data.rates.EGP || 30.85,
                        SAR: data.rates.SAR || 3.75
                    };
                    exchangeRates = newRates;
                    lastRateUpdate = Date.now();
                    document.getElementById('lastUpdate').textContent = 'Live';
                    
                    // Update displayed rate if needed
                    document.getElementById('rateValue').textContent = (exchangeRates[currentCurrency] || 1).toFixed(3);
                }
            } catch (error) {
                console.log('Using cached exchange rates:', error.name);
                document.getElementById('lastUpdate').textContent = 'Cached';
            }
        }
        
        function formatCurrency(value) {
            const rate = exchangeRates[currentCurrency] || 1;
            const convertedValue = value * rate;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currentCurrency,
                minimumFractionDigits: currentCurrency === 'EGP' ? 0 : 2,
                maximumFractionDigits: currentCurrency === 'EGP' ? 0 : 2
            }).format(convertedValue);
        }
        
        function convertFromUSD(usdValue) {
            const rate = exchangeRates[currentCurrency] || 1;
            return usdValue * rate;
        }
        
        function convertToUSD(localValue) {
            const rate = exchangeRates[currentCurrency] || 1;
            return localValue / rate;
        }
        
        function changeCurrency() {
            currentCurrency = document.getElementById('currencySelect').value;
            document.getElementById('rateValue').textContent = (exchangeRates[currentCurrency] || 1).toFixed(3);
            
            // Update rate if older than 1 hour
            if (Date.now() - lastRateUpdate > 3600000) {
                fetchExchangeRates();
            }
            
            debouncedUpdate();
        }
        
        // Break-even analysis functions
        function calculateBreakEven(fixedCosts, variableCostPerUser, revenuePerUser) {
            const contributionMargin = revenuePerUser - variableCostPerUser;
            if (contributionMargin <= 0) return { users: Infinity, revenue: Infinity, months: Infinity };
            
            const breakEvenUsers = Math.ceil(fixedCosts / contributionMargin);
            const breakEvenRevenue = breakEvenUsers * revenuePerUser;
            
            return {
                users: breakEvenUsers,
                revenue: breakEvenRevenue,
                contributionMargin: contributionMargin
            };
        }
        
        function calculateUnitEconomics(marketingCost, users, revenuePerUser, variableCostPerUser) {
            const cac = users > 0 ? marketingCost / users : 0;
            const ltv = revenuePerUser * 24; // Assuming 24 month LTV
            const ltvCacRatio = cac > 0 ? ltv / cac : 0;
            const contributionMargin = revenuePerUser - variableCostPerUser;
            const paybackPeriod = cac > 0 && contributionMargin > 0 ? cac / contributionMargin : 0;
            
            return { cac, ltv, ltvCacRatio, paybackPeriod };
        }
        
        // Sensitivity analysis
        function updateSensitivity() {
            const conversionRate = document.getElementById('sensitivityConversionSlider').value;
            const growthRate = document.getElementById('sensitivityGrowthSlider').value;
            const costPerUser = document.getElementById('sensitivityCostSlider').value;
            
            document.getElementById('sensitivityConversion').textContent = conversionRate + '%';
            document.getElementById('sensitivityGrowth').textContent = growthRate + '%';
            document.getElementById('sensitivityCost').textContent = formatCurrency(parseFloat(costPerUser));
            
            // Simulate break-even with these parameters
            const premiumPrice = parseFloat(document.getElementById('premiumPrice').value) || 3.00;
            const revenuePerUser = (premiumPrice * conversionRate / 100);
            const fixedCosts = 4000; // Total fixed costs from form (2000 + 0 + 1000 + 1000)
            
            const breakEven = calculateBreakEven(fixedCosts, parseFloat(costPerUser), revenuePerUser);
            const monthsToBreakEven = Math.ceil(Math.log(breakEven.users / 1000) / Math.log(1 + growthRate / 100));
            
            document.getElementById('sensitivityImpact').textContent = 
                `Break-even in ${monthsToBreakEven} months with ${breakEven.users.toLocaleString()} users`;
        }
        
        
        // Update loan displays function (moved outside updateModel)
        function updateLoanDisplays(users) {
            const loanSize1 = parseFloat(document.getElementById('loanSize1').value) || 2000;
            const commission1 = parseFloat(document.getElementById('commission1').value) || 0.5;
            const userReach1 = parseFloat(document.getElementById('userReach1').value) || 20;
            const successRate1 = parseFloat(document.getElementById('successRate1').value) || 15;
            
            const loanSize2 = parseFloat(document.getElementById('loanSize2').value) || 5000;
            const commission2 = parseFloat(document.getElementById('commission2').value) || 0.5;
            const userReach2 = parseFloat(document.getElementById('userReach2').value) || 10;
            const successRate2 = parseFloat(document.getElementById('successRate2').value) || 10;
            
            const eligibleUsers1 = users * (userReach1 / 100) * (successRate1 / 100);
            const loansMonth1 = eligibleUsers1 * 0.1;
            const commissionPerLoan1 = loanSize1 * (commission1 / 100);
            const loanRevenue1 = loansMonth1 * commissionPerLoan1;
            
            const eligibleUsers2 = users * (userReach2 / 100) * (successRate2 / 100);
            const loansMonth2 = eligibleUsers2 * 0.1;
            const commissionPerLoan2 = loanSize2 * (commission2 / 100);
            const loanRevenue2 = loansMonth2 * commissionPerLoan2;
            
            document.getElementById('commissionPerLoan1').textContent = formatCurrency(commissionPerLoan1);
            document.getElementById('loansPerMonth1').textContent = loansMonth1.toFixed(1);
            document.getElementById('loanRevenue1').textContent = formatCurrency(Math.round(loanRevenue1));
            
            document.getElementById('commissionPerLoan2').textContent = formatCurrency(commissionPerLoan2);
            document.getElementById('loansPerMonth2').textContent = loansMonth2.toFixed(1);
            document.getElementById('loanRevenue2').textContent = formatCurrency(Math.round(loanRevenue2));
            
            document.getElementById('totalLoanRevenue').textContent = formatCurrency(Math.round(loanRevenue1 + loanRevenue2));
        }
        
        function updateBreakEvenAnalysis(data) {
            const {projections, lastMonth, variableCostPerUser} = data;
            
            // Get current inputs
            const premiumPrice = parseFloat(document.getElementById('premiumPrice').value) || 3.00;
            const premiumConversion = parseFloat(document.getElementById('premiumConversion').value) || 20;
            const marketing = parseFloat(document.getElementById('marketing').value) || 1000;
            const salaries = parseFloat(document.getElementById('salaries').value) || 0;
            const office = parseFloat(document.getElementById('office').value) || 0;
            const servers = 0; // Servers removed from UI
            const other = parseFloat(document.getElementById('other').value) || 0;
            
            const fixedCosts = salaries + office + marketing + other;
            const revenuePerUser = (premiumPrice * premiumConversion / 100);
            
            // Calculate break-even metrics
            const breakEven = calculateBreakEven(fixedCosts, variableCostPerUser, revenuePerUser);
            const unitEcon = calculateUnitEconomics(marketing, lastMonth.users, revenuePerUser, variableCostPerUser);
            
            // Find break-even month from projections
            let breakEvenMonth = null;
            for (let i = 0; i < projections.length; i++) {
                if (projections[i].users >= breakEven.users) {
                    breakEvenMonth = i + 1;
                    break;
                }
            }
            
            // Update UI
            document.getElementById('breakEvenUsers').textContent = breakEven.users.toLocaleString();
            document.getElementById('breakEvenRevenue').textContent = formatCurrency(breakEven.revenue);
            document.getElementById('monthsToBreakEven').textContent = breakEvenMonth || '>24';
            
            document.getElementById('cac').textContent = formatCurrency(unitEcon.cac);
            document.getElementById('ltvCacRatio').textContent = unitEcon.ltvCacRatio.toFixed(1) + 'x';
            document.getElementById('paybackPeriod').textContent = unitEcon.paybackPeriod.toFixed(1);
        }
        
        // Modal functions
        function showCACModal() {
            document.body.style.cursor = 'default'; // Ensure cursor is normal
            document.getElementById('cacModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeCACModal(event) {
            if (!event || event.target.id === 'cacModal') {
                document.body.style.cursor = 'default'; // Ensure cursor is normal
                document.getElementById('cacModal').style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCACModal();
            }
        });
        
        // Ensure cursor is always reset when interacting with modal
        document.addEventListener('click', function() {
            // Small delay to ensure any loading states are processed
            setTimeout(() => {
                if (document.getElementById('cacModal').style.display !== 'flex') {
                    document.body.style.cursor = 'default';
                }
            }, 50);
        });
        
        // Mobile collapsible functionality
        function toggleMobileSection(element) {
            element.classList.toggle('active');
            const targetId = element.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.toggle('active');
            }
        }
        
        // Initialize mobile toggles
        document.addEventListener('DOMContentLoaded', function() {
            const toggles = document.querySelectorAll('.mobile-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    toggleMobileSection(this);
                });
            });
        });
        
        function updateFromTotalCost() {
            const newTotalCost = parseFloat(document.getElementById('costPerUserQuick').value) || 0.558;
            const whisperCost = parseFloat(document.getElementById('whisperCost').value) || 0.45;
            const gpt4Cost = parseFloat(document.getElementById('gpt4Cost').value) || 0.105;
            const firebaseCost = parseFloat(document.getElementById('firebaseCost').value) || 0.003;
            const currentTotal = whisperCost + gpt4Cost + firebaseCost;
            
            if (currentTotal > 0) {
                const whisperRatio = whisperCost / currentTotal;
                const gpt4Ratio = gpt4Cost / currentTotal;
                const firebaseRatio = firebaseCost / currentTotal;
                
                document.getElementById('whisperCost').value = (newTotalCost * whisperRatio).toFixed(3);
                document.getElementById('gpt4Cost').value = (newTotalCost * gpt4Ratio).toFixed(3);
                document.getElementById('firebaseCost').value = (newTotalCost * firebaseRatio).toFixed(3);
            }
            
            debouncedUpdate();
        }
        
        function setScenario(scenario) {
            currentScenario = scenario;
            
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-scenario="${scenario}"]`).classList.add('active');
            
            document.getElementById('customRateInput').style.display = 
                scenario === 'custom' ? 'block' : 'none';
            
            const rate = scenario === 'custom' ? 
                parseFloat(document.getElementById('customRate').value) : 
                growthRates[scenario];
            document.getElementById('currentGrowthRate').textContent = rate;
            
            debouncedUpdate();
        }
        
        function updateModel() {
            // Add loading state
            document.body.style.cursor = 'wait';
            
            // Check if inputs changed (memoization)
            const currentHash = getInputHash();
            if (currentHash === lastInputHash && cachedProjections) {
                updateUI(cachedProjections);
                document.body.style.cursor = 'default';
                return;
            }
            
            // Get all inputs with validation
            const customRate = validateInput(document.getElementById('customRate'), 1, 200);
            const initialFunding = validateInput(document.getElementById('initialFunding'), 0, 10000000);
            
            const whisperCost = validateInput(document.getElementById('whisperCost'), 0, 10);
            const gpt4Cost = validateInput(document.getElementById('gpt4Cost'), 0, 10);
            const firebaseCost = validateInput(document.getElementById('firebaseCost'), 0, 10);
            const variableCostPerUser = whisperCost + gpt4Cost + firebaseCost;
            
            // Update displays
            document.getElementById('totalVariableCost').value = variableCostPerUser.toFixed(3);
            document.getElementById('costPerUserQuick').value = variableCostPerUser.toFixed(3);
            document.getElementById('whisperDisplay').textContent = whisperCost.toFixed(3);
            document.getElementById('gpt4Display').textContent = gpt4Cost.toFixed(3);
            document.getElementById('firebaseDisplay').textContent = firebaseCost.toFixed(3);
            
            const salaries = validateInput(document.getElementById('salaries'), 0, 1000000);
            const office = validateInput(document.getElementById('office'), 0, 100000);
            const marketing = validateInput(document.getElementById('marketing'), 0, 500000);
            const other = validateInput(document.getElementById('other'), 0, 100000);
            
            const premiumPrice = validateInput(document.getElementById('premiumPrice'), 0, 1000);
            const premiumConversion = validateInput(document.getElementById('premiumConversion'), 0, 100);
            
            const loanSize1 = validateInput(document.getElementById('loanSize1'), 100, 1000000);
            const commission1 = validateInput(document.getElementById('commission1'), 0, 10);
            const userReach1 = validateInput(document.getElementById('userReach1'), 0, 100);
            const successRate1 = validateInput(document.getElementById('successRate1'), 0, 100);
            
            const loanSize2 = validateInput(document.getElementById('loanSize2'), 100, 1000000);
            const commission2 = validateInput(document.getElementById('commission2'), 0, 10);
            const userReach2 = validateInput(document.getElementById('userReach2'), 0, 100);
            const successRate2 = validateInput(document.getElementById('successRate2'), 0, 100);
            
            document.getElementById('customRateDisplay').textContent = customRate;
            const currentRate = currentScenario === 'custom' ? customRate : growthRates[currentScenario];
            document.getElementById('currentGrowthRate').textContent = currentRate;
            growthRates.custom = customRate;
            
            // Calculate projections for 24 months
            const months = 24;
            const targetYear1Users = 50000;
            const growthRate = growthRates[currentScenario] / 100;
            const startingUsers = targetYear1Users / Math.pow(1 + growthRate, 11);
            
            let cashPosition = initialFunding;
            const projections = [];
            let totalBurn = 0;
            let firstProfitableMonth = null;
            
            const fixedCosts = salaries + office + marketing + other;
            
            for (let i = 1; i <= months; i++) {
                const users = Math.round(startingUsers * Math.pow(1 + growthRate, i - 1));
                
                const variableCosts = users * variableCostPerUser;
                const totalCosts = variableCosts + fixedCosts;
                
                const premiumUsers = users * (premiumConversion / 100);
                const premiumRevenue = premiumUsers * premiumPrice;
                
                const eligibleUsers1 = users * (userReach1 / 100) * (successRate1 / 100);
                const loansMonth1 = eligibleUsers1 * 0.1;
                const commissionPerLoan1 = loanSize1 * (commission1 / 100);
                const loanRevenue1 = loansMonth1 * commissionPerLoan1;
                
                const eligibleUsers2 = users * (userReach2 / 100) * (successRate2 / 100);
                const loansMonth2 = eligibleUsers2 * 0.1;
                const commissionPerLoan2 = loanSize2 * (commission2 / 100);
                const loanRevenue2 = loansMonth2 * commissionPerLoan2;
                
                const totalLoanRevenue = loanRevenue1 + loanRevenue2;
                const totalRevenue = premiumRevenue + totalLoanRevenue;
                
                const profit = totalRevenue - totalCosts;
                
                if (profit >= 0 && firstProfitableMonth === null) {
                    firstProfitableMonth = i;
                }
                
                if (profit < 0) {
                    totalBurn += Math.abs(profit);
                }
                
                cashPosition += profit;
                
                const arpu = users > 0 ? totalRevenue / users : 0;
                
                projections.push({
                    month: i,
                    users: users,
                    revenue: Math.round(totalRevenue),
                    costs: Math.round(totalCosts),
                    profit: Math.round(profit),
                    cashPosition: Math.round(cashPosition),
                    arpu: arpu.toFixed(2)
                });
            }
            
            // Cache results and update UI
            lastInputHash = currentHash;
            cachedProjections = {
                projections,
                lastMonth: projections[projections.length - 1],
                year1Month: projections[11],
                totalBurn,
                firstProfitableMonth,
                variableCostPerUser
            };
            
            updateUI(cachedProjections);
            document.body.style.cursor = 'default';
        }
        
        // Optimized table update function
        function updateTableIfChanged(projections, year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit, lastMonth) {
            try {
                const tableData = JSON.stringify({projections, year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit});
                if (tableData === lastTableData) return;
                lastTableData = tableData;
                
                // Update table
                const tbody = document.getElementById('projectionsTable');
                if (!tbody) {
                    console.error('Table body not found');
                    return;
                }
                tbody.innerHTML = '';
            
            projections.forEach((proj, index) => {
                if (index === 12) {
                    const summaryRow = tbody.insertRow();
                    summaryRow.style.background = '#fbbf24';
                    summaryRow.style.fontWeight = 'bold';
                    summaryRow.innerHTML = `
                        <td>YEAR 1 TOTAL</td>
                        <td>-</td>
                        <td>${formatCurrency(year1Revenue)}</td>
                        <td>${formatCurrency(year1Costs)}</td>
                        <td class="${year1Profit >= 0 ? 'text-green' : 'text-red'}">
                            ${formatCurrency(year1Profit)}
                        </td>
                        <td>-</td>
                        <td>-</td>
                    `;
                    
                    const separatorRow = tbody.insertRow();
                    separatorRow.innerHTML = `
                        <td colspan="7" style="background: linear-gradient(to right, #3b82f6, #8b5cf6); color: white; text-align: center; font-weight: bold; padding: 10px;">
                            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê YEAR 2 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        </td>
                    `;
                }
                
                const row = tbody.insertRow();
                const isYear2 = index >= 12;
                row.style.background = isYear2 ? (index % 2 === 0 ? '#f0f9ff' : '#e0f2fe') : '';
                
                row.innerHTML = `
                    <td style="font-weight: ${index === 11 || index === 23 ? 'bold' : 'normal'}">
                        Month ${proj.month} ${index === 11 ? '(Y1 End)' : index === 23 ? '(Y2 End)' : ''}
                    </td>
                    <td>${proj.users.toLocaleString()}</td>
                    <td>${formatCurrency(proj.revenue)}</td>
                    <td>${formatCurrency(proj.costs)}</td>
                    <td class="${proj.profit >= 0 ? 'text-green' : 'text-red'}">
                        ${formatCurrency(proj.profit)}
                    </td>
                    <td>${formatCurrency(proj.cashPosition)}</td>
                    <td>${formatCurrency(proj.arpu)}</td>
                `;
            });
            
            const year2SummaryRow = tbody.insertRow();
            year2SummaryRow.style.background = '#fbbf24';
            year2SummaryRow.style.fontWeight = 'bold';
            year2SummaryRow.innerHTML = `
                <td>YEAR 2 TOTAL</td>
                <td>-</td>
                <td>${formatCurrency(year2Revenue)}</td>
                <td>${formatCurrency(year2Costs)}</td>
                <td class="${year2Profit >= 0 ? 'text-green' : 'text-red'}">
                    ${formatCurrency(year2Profit)}
                </td>
                <td>-</td>
                <td>-</td>
            `;
            
            const grandTotalRow = tbody.insertRow();
            grandTotalRow.style.background = 'linear-gradient(to right, #10b981, #059669)';
            grandTotalRow.style.color = 'white';
            grandTotalRow.style.fontWeight = 'bold';
            const totalRevenue = year1Revenue + year2Revenue;
            const totalCosts = year1Costs + year2Costs;
            const totalProfit = year1Profit + year2Profit;
            grandTotalRow.innerHTML = `
                <td>2-YEAR TOTAL</td>
                <td>${lastMonth.users.toLocaleString()} users</td>
                <td>${formatCurrency(totalRevenue)}</td>
                <td>${formatCurrency(totalCosts)}</td>
                <td>${formatCurrency(totalProfit)}</td>
                <td>${formatCurrency(lastMonth.cashPosition)}</td>
                <td>-</td>
            `;
            } catch (error) {
                console.error('Error updating table:', error);
            }
        }
        
        function updateUI(data) {
            const {projections, lastMonth, year1Month, totalBurn, firstProfitableMonth, variableCostPerUser} = data;
            
            updateLoanDisplays(lastMonth.users);
            
            document.getElementById('year1Users').textContent = year1Month.users.toLocaleString();
            document.getElementById('year2Users').textContent = lastMonth.users.toLocaleString();
            document.getElementById('finalRevenue').textContent = formatCurrency(lastMonth.revenue);
            document.getElementById('arpu').textContent = formatCurrency(lastMonth.arpu);
            document.getElementById('year1Profit').textContent = formatCurrency(year1Month.profit);
            
            const profitElement = document.getElementById('finalProfit');
            profitElement.textContent = formatCurrency(lastMonth.profit);
            profitElement.className = 'metric-value ' + (lastMonth.profit >= 0 ? 'text-green' : 'text-red');
            
            document.getElementById('cashPosition').textContent = formatCurrency(lastMonth.cashPosition);
            
            const currentBurnRate = lastMonth.profit < 0 ? Math.abs(lastMonth.profit) : 0;
            const runway = currentBurnRate > 0 ? Math.round(lastMonth.cashPosition / currentBurnRate) : Infinity;
            document.getElementById('runway').textContent = runway === Infinity ? '‚àû' : runway + ' months';
            
            document.getElementById('profitableMonth').textContent = 
                firstProfitableMonth ? 'Month ' + firstProfitableMonth : 'Beyond 24 months';
            document.getElementById('totalBurn').textContent = formatCurrency(Math.round(totalBurn));
            document.getElementById('unitEconomics').textContent = formatCurrency(variableCostPerUser);
            document.getElementById('finalUsersCount').textContent = lastMonth.users.toLocaleString();
            
            // Update break-even analysis
            updateBreakEvenAnalysis(data);
            
            // Calculate yearly summaries
            let year1Revenue = 0, year1Costs = 0, year1Profit = 0;
            let year2Revenue = 0, year2Costs = 0, year2Profit = 0;
            
            projections.forEach((proj, index) => {
                if (index < 12) {
                    year1Revenue += proj.revenue;
                    year1Costs += proj.costs;
                    year1Profit += proj.profit;
                } else {
                    year2Revenue += proj.revenue;
                    year2Costs += proj.costs;
                    year2Profit += proj.profit;
                }
            });
            
            // Use optimized table update
            updateTableIfChanged(projections, year1Revenue, year1Costs, year1Profit, year2Revenue, year2Costs, year2Profit, lastMonth);
        }
        
        // Initialize on load (non-blocking)
        setTimeout(() => {
            updateModel();
        }, 10);
        
        // Fetch exchange rates in background (non-blocking)
        setTimeout(() => {
            fetchExchangeRates();
        }, 500);
        
        // Failsafe to ensure cursor is reset after all initialization
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.body.style.cursor = 'default';
            }, 1000);
        });
    </script>
</body>
</html>
